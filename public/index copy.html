<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Manager - Panel de Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <!--<link rel="stylesheet" href="css/style_minimal.css">-->
    <link rel="stylesheet" href="css/style.css">
    <!-- al final del <head> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

</head>

<body>
    <script>
        let loginAttempts = 0;
        const maxAttempts = 50; // M√°ximo de intentos permitidos

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (loginAttempts >= maxAttempts) {
                showError('Demasiados intentos fallidos. Espera 5 minutos.');
                return;
            }

            const loginBtn = document.getElementById('loginBtn');
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!email || !password) {
                showError('Por favor, completa todos los campos');
                return;
            }

            // Mostrar loading
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div class="loading"></div> Iniciando sesi√≥n...';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        rememberMe
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Guardar token y datos usando el m√≥dulo auth
                    const storage = rememberMe ? localStorage : sessionStorage;
                    storage.setItem('authToken', data.token);
                    storage.setItem('userData', JSON.stringify(data.user));

                    showSuccess('¬°Inicio de sesi√≥n exitoso! Redirigiendo...');

                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    loginAttempts++;
                    showError(data.error || 'Error al iniciar sesi√≥n');
                }
            } catch (error) {
                console.error('Error de conexi√≥n:', error);
                showError('Error de conexi√≥n. Verifica tu internet.');
            } finally {
                // Restaurar bot√≥n
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Iniciar Sesi√≥n';
            }
        });

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.querySelector('.password-toggle');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');

            successDiv.style.display = 'none';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';

            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');

            errorDiv.style.display = 'none';
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }

        function showForgotPassword() {
            alert('Contacta al administrador del sistema para restablecer tu contrase√±a.');
        }

        // Verificar si ya est√° logueado
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            if (token) {
                // Verificar token v√°lido
                fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '/';
                        }
                    })
                    .catch(() => {
                        // Token inv√°lido, limpiar
                        localStorage.removeItem('authToken');
                        sessionStorage.removeItem('authToken');
                        localStorage.removeItem('userData');
                        sessionStorage.removeItem('userData');
                    });
            }
        });

        // Limitar intentos de login por tiempo
        setTimeout(() => {
            loginAttempts = 0;
        }, 300000); // Reset despu√©s de 5 minutos
    </script>
    <script>
        // Funci√≥n global para manejo de cambio de secciones que activa el monitor QR
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Mostrar la secci√≥n seleccionada
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');

                // Si es la secci√≥n de monitor de bots, inicializar o recargar
                if (sectionId === 'bot-monitor' && typeof loadMonitorTab === 'function') {
                    loadMonitorTab();
                }
            }

            // Actualizar navegaci√≥n
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const navItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
        }
    </script>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> WhatsApp Bot Manager</h1>
            <p>Plataforma de Gesti√≥n Integral de Bots para Empresas</p>
        </div>

        <div class="main-content">
            <nav class="sidebar">
                <div class="nav-section">
                    <div class="nav-section-title">Panel Principal</div>
                    <a href="#" class="nav-item active" data-section="dashboard">
                        <i class="fas fa-chart-bar"></i> Dashboard
                    </a>
                    <a href="#" class="nav-item" data-section="plans">
                        <i class="fas fa-dollar-sign"></i> Planes y Precios
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Usuario</div>
                    <a href="#" class="nav-item" data-section="profile">
                        <i class="fas fa-user-circle"></i> Mi Perfil
                    </a>
                    <a href="#" class="nav-item" onclick="auth.logout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Gesti√≥n de Bots</div>
                    <a href="#" class="nav-item" data-section="bot-monitor">
                        <i class="fas fa-qrcode"></i> Monitor de Bots
                    </a>

                    <a href="#" class="nav-item" data-section="bots">
                        <i class="fas fa-robot"></i> Mis Bots
                    </a>
                    <a href="#" class="nav-item" data-section="create-bot">
                        <i class="fas fa-plus"></i> Crear Nuevo Bot
                    </a>
                    <a href="#" class="nav-item" data-section="templates">
                        <i class="fas fa-clipboard-list"></i> Plantillas
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Configuraci√≥n</div>
                    <a href="#" class="nav-item" data-section="flows">
                        <i class="fas fa-project-diagram"></i> Flujos
                    </a>
                    <a href="#" class="nav-item" data-section="menus">
                        <i class="fas fa-mobile-alt"></i> Men√∫s
                    </a>
                    <a href="#" class="nav-item" data-section="apis">
                        <i class="fas fa-plug"></i> APIs
                    </a>
                    <a href="#" class="nav-item" data-section="ai-config">
                        <i class="fas fa-brain"></i> IA & Gemini
                    </a>
                    <a href="#" class="nav-item" data-section="messages">
                        <i class="fas fa-comments"></i> Mensajes
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Monitoreo</div>
                    <a href="#" class="nav-item" data-section="analytics">
                        <i class="fas fa-chart-line"></i> Anal√≠ticas
                    </a>
                    <a href="#" class="nav-item" data-section="users">
                        <i class="fas fa-users"></i> Usuarios
                    </a>
                    <a href="#" class="nav-item" data-section="logs">
                        <i class="fas fa-clipboard-list"></i> Logs
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Avanzado</div>
                    <a href="#" class="nav-item" data-section="code-generator">
                        <i class="fas fa-code"></i> Generador
                    </a>
                    <a href="#" class="nav-item" data-section="deploy">
                        <i class="fas fa-rocket"></i> Despliegue
                    </a>
                    <a href="#" class="nav-item" data-section="backup">
                        <i class="fas fa-save"></i> Respaldos
                    </a>
                </div>
            </nav>

            <div class="content-area">
                <!-- Dashboard -->
                <div id="dashboard" class="section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalBots">0</div>
                            <div class="stat-label">Bots Activos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalMessages">0</div>
                            <div class="stat-label">Mensajes Hoy</div>
                        </div>
                        <div class="stat-card admin-only">
                            <div class="stat-value" id="totalClients">0</div>
                            <div class="stat-label">Clientes</div>
                        </div>
                        <div class="stat-card admin-only">
                            <div class="stat-value" id="monthlyRevenue">$0</div>
                            <div class="stat-label">Ingresos/Mes</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-globe"></i> Estado del Sistema</h3>
                        <div class="grid-3">
                            <div>
                                <p><strong>Servidor:</strong> <span class="status-indicator status-online"><span
                                            class="status-dot"></span>Operativo</span></p>
                                <p><strong>Base de Datos:</strong> <span class="status-indicator status-online"><span
                                            class="status-dot"></span>Conectada</span></p>
                            </div>
                            <!--<div>
                                <p><strong>WhatsApp API:</strong> <span class="status-indicator status-online"><span
                                            class="status-dot"></span>Funcional</span></p>
                                <p><strong>Gemini AI:</strong> <span class="status-indicator status-online"><span
                                            class="status-dot"></span>Disponible</span></p>
                            </div>-->
                            <div>
                                <!--<p><strong>SSL/HTTPS:</strong> <span class="status-indicator status-online"><span
                                            class="status-dot"></span>Activo</span></p>-->
                                <p><strong>WebSocket:</strong> <span class="status-indicator status-online"><span
                                            class="status-dot"></span>Conectado</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-mobile-alt"></i> Bots Recientes</h3>
                        <div id="recentBots">
                            <div class="empty-state">
                                <i class="fas fa-robot"></i>
                                <h4>¬°Bienvenido al Bot Manager!</h4>
                                <p>No tienes bots creados a√∫n. ¬°Comienza creando tu primer bot!</p>
                                <button class="btn btn-primary" onclick="showSection('create-bot')">
                                    <i class="fas fa-plus"></i> Crear Mi Primer Bot
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Planes y Precios -->
                <div id="plans" class="section">
                    <div class="card">
                        <h2 style="text-align: center; margin-bottom: 30px;">
                            <i class="fas fa-crown"></i> Planes de Servicio
                        </h2>
                        <div class="grid-3">
                            <div class="plan-card" data-plan="emprendedor" onclick="selectPlan('emprendedor')">
                                <h4><i class="fas fa-rocket"></i> Plan Emprendedor Local</h4>
                                <div class="plan-price">$1,199<small>/mes</small></div>
                                <div style="margin-bottom: 20px; color: #6c757d;">üí° Flexible: $2,000 + $699/mes</div>
                                <ul class="feature-list">
                                    <li>Bot con 3 flujos conversacionales</li>
                                    <li>Hasta 1,500 mensajes/mes</li>
                                    <li>Configuraci√≥n personalizada inicial</li>
                                    <li>Soporte por WhatsApp y email</li>
                                    <li>Instalaci√≥n remota incluida</li>
                                    <li>Capacitaci√≥n paso a paso</li>
                                    <li>1 ajuste de flujos al mes</li>
                                </ul>
                                <button class="btn btn-primary" onclick="selectPlan('emprendedor')">
                                    <i class="fas fa-check"></i> Seleccionar Plan
                                </button>
                            </div>

                            <div class="plan-card" data-plan="profesional" onclick="selectPlan('profesional')">
                                <h4><i class="fas fa-star"></i> Plan Profesional Eficiente</h4>
                                <div class="plan-price">$2,999<small>/mes</small></div>
                                <div style="margin-bottom: 20px; color: #6c757d;">üí° Flexible: $4,000 + $1,599/mes</div>
                                <ul class="feature-list">
                                    <li>Todo del Plan Emprendedor Local</li>
                                    <li>Hasta 7 flujos conversacionales</li>
                                    <li>Hasta 5,000 mensajes/mes</li>
                                    <li>Integraci√≥n API b√°sica</li>
                                    <li>Soporte prioritario por tel√©fono</li>
                                    <li>Reportes b√°sicos de anal√≠tica</li>
                                    <li>Visita t√©cnica trimestral</li>
                                    <li>2 ajustes de flujos al mes</li>
                                </ul>
                                <button class="btn btn-primary" onclick="selectPlan('profesional')">
                                    <i class="fas fa-check"></i> Seleccionar Plan
                                </button>
                            </div>

                            <div class="plan-card" data-plan="empresarial" onclick="selectPlan('empresarial')">
                                <h4><i class="fas fa-building"></i> Plan Empresarial Avanzado</h4>
                                <div class="plan-price">$6,999<small>/mes</small></div>
                                <div style="margin-bottom: 20px; color: #6c757d;">üí° Flexible: $8,000 + $4,499/mes</div>
                                <ul class="feature-list">
                                    <li>Todo del Plan Profesional</li>
                                    <li>Flujos conversacionales ilimitados</li>
                                    <li>Mensajes virtualmente ilimitados</li>
                                    <li>M√∫ltiples n√∫meros/bots</li>
                                    <li>Integraciones API avanzadas</li>
                                    <li>Consultor√≠a en automatizaci√≥n</li>
                                    <li>Garant√≠a SLA</li>
                                    <li>Soporte premium presencial</li>
                                </ul>
                                <button class="btn btn-primary" onclick="selectPlan('empresarial')">
                                    <i class="fas fa-check"></i> Seleccionar Plan
                                </button>
                            </div>
                        </div>

                        <div
                            style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 30px; border-radius: 15px; margin-top: 30px; text-align: center;">
                            <h3><i class="fas fa-gift"></i> Promoci√≥n de Lanzamiento - Solo Tapachula</h3>
                            <div class="grid-2" style="margin-top: 20px;">
                                <div>
                                    <h4><i class="fas fa-percentage"></i> 25% de Descuento</h4>
                                    <p>En los primeros 3 meses</p>
                                </div>
                                <div>
                                    <h4><i class="fas fa-home"></i> Instalaci√≥n Gratis</h4>
                                    <p>Para los primeros 10 clientes</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mis Bots -->
                <div id="bots" class="section">
                    <div class="card">
                        <h3><i class="fas fa-robot"></i> Gesti√≥n de Bots</h3>
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="showSection('create-bot')">
                                <i class="fas fa-plus"></i> Crear Nuevo Bot
                            </button>
                            <button class="btn btn-secondary" onclick="refreshBots()">
                                <i class="fas fa-sync"></i> Actualizar
                            </button>
                            <button class="btn btn-warning" onclick="exportBots()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>

                        <div id="botsList">
                            <div class="empty-state">
                                <i class="fas fa-robot"></i>
                                <h4>No tienes bots creados</h4>
                                <p>¬°Comienza creando tu primer bot para automatizar tu negocio!</p>
                                <button class="btn btn-primary" onclick="showSection('create-bot')">
                                    <i class="fas fa-plus"></i> Crear Mi Primer Bot
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Crear Nuevo Bot -->
                <div id="create-bot" class="section">
                    <div class="card">
                        <h3><i class="fas fa-plus"></i> Asistente de Creaci√≥n de Bot</h3>

                        <div class="progress-bar">
                            <div class="progress-fill" id="wizardProgress" style="width: 25%;"></div>
                        </div>

                        <!-- Paso 1: Informaci√≥n B√°sica -->
                        <div class="wizard-step active" id="step1">
                            <h4><i class="fas fa-info-circle"></i> Paso 1: Informaci√≥n B√°sica</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Nombre del Bot *</label>
                                    <input type="text" class="form-control" id="botName"
                                        placeholder="Ej: Bot JOGM Servicios" required>
                                </div>
                                <div class="form-group">
                                    <label>Empresa/Cliente *</label>
                                    <input type="text" class="form-control" id="companyName"
                                        placeholder="Ej: JOGM Servicios" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Plan Seleccionado</label>
                                <select class="form-control" id="selectedPlan">
                                    <option value="emprendedor">Emprendedor Local ($1,199/mes)</option>
                                    <option value="profesional">Profesional Eficiente ($2,999/mes)</option>
                                    <option value="empresarial">Empresarial Avanzado ($6,999/mes)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Descripci√≥n del Negocio</label>
                                <textarea class="form-control" id="businessDescription" rows="3"
                                    placeholder="Describe brevemente el giro del negocio y los servicios que ofrece..."></textarea>
                            </div>
                            <div style="text-align: center; margin-top: 30px;">
                                <button class="btn btn-primary" onclick="nextStep(2)">
                                    <i class="fas fa-arrow-right"></i> Siguiente
                                </button>
                            </div>
                        </div>

                        <!-- Paso 2: Configuraci√≥n WhatsApp -->
                        <div class="wizard-step" id="step2">
                            <h4><i class="fab fa-whatsapp"></i> Paso 2: Configuraci√≥n WhatsApp</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>N√∫mero de Administrador *
                                        <span class="tooltip" data-tooltip="Formato: 521 + 10 d√≠gitos (M√©xico)">
                                            <i class="fas fa-question-circle"></i>
                                        </span>
                                    </label>
                                    <input type="text" class="form-control" id="adminNumber" placeholder="521XXXXXXXXXX"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label>Prefijo de Comandos Admin</label>
                                    <input type="text" class="form-control" id="commandPrefix" value="!" maxlength="1">
                                </div>
                            </div>

                            <div class="url-preview">
                                <h5><i class="fas fa-link"></i> URL de tu Bot</h5>
                                <div class="url">https://localhost/<span id="tokenPreview">xxxxx</span></div>
                                <p>Esta ser√° la URL √∫nica de tu bot en el servidor</p>
                                <input type="hidden" id="botToken">
                                <button type="button" class="btn btn-secondary" onclick="generateBotToken()">
                                    <i class="fas fa-sync"></i> Generar Nuevo Token
                                </button>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button class="btn btn-secondary" onclick="prevStep(1)">
                                    <i class="fas fa-arrow-left"></i> Anterior
                                </button>
                                <button class="btn btn-primary" onclick="nextStep(3)">
                                    <i class="fas fa-arrow-right"></i> Siguiente
                                </button>
                            </div>
                        </div>

                        <!-- Paso 3: Integraciones -->
                        <div class="wizard-step" id="step3">
                            <h4><i class="fas fa-plug"></i> Paso 3: Integraciones y APIs</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>URL Base de API (Opcional)</label>
                                    <input type="url" class="form-control" id="apiBaseUrl"
                                        placeholder="https://miempresa.com/api/">
                                </div>
                                <div class="form-group">
                                    <label>Contrase√±a/Token de API</label>
                                    <input type="password" class="form-control" id="apiPassword"
                                        placeholder="Token de acceso a tu API">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="enableAI" style="margin-right: 10px;"
                                        onchange="toggleAIConfig()">
                                    Habilitar Asistente con Inteligencia Artificial (Gemini)
                                </label>
                            </div>

                            <div id="aiConfig" style="display: none;">
                                <div class="form-group">
                                    <label>Google API Key (Gemini)</label>
                                    <input type="password" class="form-control" id="geminiApiKey"
                                        placeholder="Ingresa tu API Key de Google Gemini">
                                    <small style="color: #6c757d;">
                                        <i class="fas fa-external-link-alt"></i>
                                        <a href="https://makersuite.google.com/app/apikey" target="_blank">Obtener API
                                            Key gratis aqu√≠</a>
                                    </small>
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button class="btn btn-secondary" onclick="prevStep(2)">
                                    <i class="fas fa-arrow-left"></i> Anterior
                                </button>
                                <button class="btn btn-primary" onclick="nextStep(4)">
                                    <i class="fas fa-arrow-right"></i> Siguiente
                                </button>
                            </div>
                        </div>

                        <!-- Paso 4: Finalizar -->
                        <div class="wizard-step" id="step4">
                            <h4><i class="fas fa-check-circle"></i> Paso 4: Configuraciones Finales</h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Timeout de Sesi√≥n (minutos)</label>
                                    <input type="number" class="form-control" id="sessionTimeout" value="15" min="5"
                                        max="120">
                                </div>
                                <div class="form-group">
                                    <label>Pausa por Defecto (minutos)</label>
                                    <input type="number" class="form-control" id="defaultPause" value="30" min="10"
                                        max="1440">
                                </div>
                            </div>

                            <div class="card" style="background: #f8f9fa; border: 2px dashed #25D366;">
                                <h5><i class="fas fa-eye"></i> Resumen de Configuraci√≥n</h5>
                                <div id="botSummary">
                                    <!-- Se llenar√° din√°micamente -->
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button class="btn btn-secondary" onclick="prevStep(3)">
                                    <i class="fas fa-arrow-left"></i> Anterior
                                </button>
                                <button class="btn btn-success" onclick="createBot()" id="createBotBtn">
                                    <i class="fas fa-rocket"></i> Crear Bot
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Plantillas -->
                <div id="templates" class="section">
                    <div class="card">
                        <h3><i class="fas fa-clipboard-list"></i> Plantillas de Bot</h3>
                        <p style="margin-bottom: 30px;">Selecciona una plantilla para crear r√°pidamente un bot
                            especializado para tu tipo de negocio.</p>

                        <div class="grid-3">
                            <div class="bot-card" onclick="selectTemplate('servicios')">
                                <h4><i class="fas fa-tools"></i> Servicios T√©cnicos</h4>
                                <p>Bot especializado para talleres, reparaciones y servicios t√©cnicos.</p>
                                <ul style="font-size: 0.9rem; color: #6c757d; list-style: none; padding: 0;">
                                    <li>‚úì 7 flujos conversacionales</li>
                                    <li>‚úì Gesti√≥n de folios y garant√≠as</li>
                                    <li>‚úì Sistema de citas</li>
                                    <li>‚úì Consulta de estados</li>
                                </ul>
                                <button class="btn btn-primary" onclick="applyTemplate('servicios')">
                                    <i class="fas fa-check"></i> Usar Plantilla
                                </button>
                            </div>

                            <div class="bot-card" onclick="selectTemplate('restaurante')">
                                <h4><i class="fas fa-utensils"></i> Restaurante/Comida</h4>
                                <p>Bot para restaurantes con men√∫ digital y pedidos a domicilio.</p>
                                <ul style="font-size: 0.9rem; color: #6c757d; list-style: none; padding: 0;">
                                    <li>‚úì Men√∫ interactivo</li>
                                    <li>‚úì Pedidos a domicilio</li>
                                    <li>‚úì Sistema de reservas</li>
                                    <li>‚úì Promociones especiales</li>
                                </ul>
                                <button class="btn btn-primary" onclick="applyTemplate('restaurante')">
                                    <i class="fas fa-check"></i> Usar Plantilla
                                </button>
                            </div>

                            <div class="bot-card" onclick="selectTemplate('personalizado')">
                                <h4><i class="fas fa-cog"></i> Personalizado</h4>
                                <p>Crea tu bot desde cero con configuraciones espec√≠ficas.</p>
                                <ul style="font-size: 0.9rem; color: #6c757d; list-style: none; padding: 0;">
                                    <li>‚úì Configuraci√≥n libre</li>
                                    <li>‚úì Flujos personalizados</li>
                                    <li>‚úì Integraciones espec√≠ficas</li>
                                    <li>‚úì Dise√±o a medida</li>
                                </ul>
                                <button class="btn btn-primary" onclick="applyTemplate('personalizado')">
                                    <i class="fas fa-check"></i> Usar Plantilla
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flujos Conversacionales Mejorados -->
                <div id="flows" class="section">

                    <div class="card">
                        <h3><i class="fas fa-project-diagram"></i> Editor de Flujos Conversacionales</h3>

                        <!-- Barra de herramientas principal -->
                        <div class="flows-toolbar">
                            <div class="toolbar-left">
                                <select class="form-control" id="selectedBotForFlows">
                                    <option value="">Selecciona un bot para editar</option>
                                </select>
                                <button class="btn btn-primary" onclick="addNewFlow()">
                                    <i class="fas fa-plus"></i> Nuevo Flujo
                                </button>
                                <button class="btn btn-secondary" onclick="loadFlows()">
                                    <i class="fas fa-sync"></i> Actualizar
                                </button>
                            </div>
                            <div class="toolbar-right">
                                <div class="flow-search">
                                    <input type="text" class="form-control" placeholder="Buscar flujo..."
                                        id="flowSearchInput">
                                    <i class="fas fa-search"></i>
                                </div>
                                <button class="btn btn-outline-secondary" onclick="importFlow()">
                                    <i class="fas fa-file-import"></i> Importar
                                </button>
                                <button class="btn btn-outline-secondary" onclick="exportAllFlows()">
                                    <i class="fas fa-file-export"></i> Exportar
                                </button>
                            </div>
                        </div>

                        <!-- √Årea de contenido principal -->
                        <div class="flows-content show-properties"> <!-- Panel izquierdo: Lista de flujos -->
                            <div class="flows-sidebar" id="flowsList">
                                <div class="flows-header">
                                    <h4>Flujos</h4>
                                    <span class="flows-count" id="flowsCount">0</span>
                                </div>
                                <div class="flows-list-container" id="flowsListContainer">
                                    <div class="empty-state">
                                        <i class="fas fa-project-diagram"></i>
                                        <p>No hay flujos disponibles</p>
                                    </div>
                                </div>
                                <!-- Plantillas de flujo -->
                                <div class="flows-templates">
                                    <h5><i class="fas fa-star"></i> Plantillas</h5>
                                    <div class="template-item" onclick="applyFlowTemplate('menuPrincipal')">
                                        <i class="fas fa-th-large"></i> Men√∫ Principal
                                    </div>
                                    <div class="template-item" onclick="applyFlowTemplate('servicios')">
                                        <i class="fas fa-concierge-bell"></i> Cat√°logo de Servicios
                                    </div>
                                    <div class="template-item" onclick="applyFlowTemplate('citas')">
                                        <i class="fas fa-calendar-check"></i> Agenda de Citas
                                    </div>
                                    <div class="template-item" onclick="applyFlowTemplate('consultas')">
                                        <i class="fas fa-search"></i> Consulta de Estado
                                    </div>
                                </div>
                            </div>

                            <!-- Panel central: Editor de flujo -->
                            <div class="flow-editor" id="flowEditor">
                                <div class="flow-editor-placeholder" id="flowEditorPlaceholder">
                                    <i class="fas fa-code-branch fa-3x"></i>
                                    <h4>Editor de Flujos</h4>
                                    <p>Selecciona un flujo existente o crea uno nuevo para comenzar a editarlo</p>
                                    <button class="btn btn-primary" onclick="addNewFlow()">
                                        <i class="fas fa-plus"></i> Crear Nuevo Flujo
                                    </button>
                                </div>

                                <!-- √Årea de edici√≥n del flujo actual -->
                                <div class="flow-edit-container" id="flowEditContainer" style="display: none;">
                                    <!-- Cabecera del editor -->
                                    <div class="flow-edit-header">
                                        <div class="flow-title-area">
                                            <input type="text" class="form-control" id="flowName"
                                                placeholder="Nombre del flujo">
                                            <div class="flow-status">
                                                <span class="status-indicator status-enabled">
                                                    <span class="status-dot"></span> Activo
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flow-actions">
                                            <button class="btn btn-outline-secondary btn-sm" onclick="previewFlow()">
                                                <i class="fas fa-eye"></i> Vista Previa
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm"
                                                onclick="duplicateCurrentFlow()">
                                                <i class="fas fa-copy"></i> Duplicar
                                            </button>
                                            <button class="btn btn-success btn-sm" onclick="saveCurrentFlow()">
                                                <i class="fas fa-save"></i> Guardar
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning"
                                                onclick="toggleCurrentFlowStatus()">
                                                <i class="fas fa-pause"></i> Desactivar
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCurrentFlow()">
                                                <i class="fas fa-trash"></i> Eliminar Flujo
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Descripci√≥n del flujo -->
                                    <div class="flow-description">
                                        <textarea class="form-control" id="flowDescription"
                                            placeholder="Descripci√≥n del flujo (opcional)"></textarea>
                                    </div>

                                    <!-- Pesta√±as del editor -->
                                    <div class="flow-edit-tabs">
                                        <div class="tab-button active" data-tab="diagram">Diagrama</div>
                                        <div class="tab-button" data-tab="steps">Pasos</div>
                                        <div class="tab-button" data-tab="options">Opciones</div>
                                        <div class="tab-button" data-tab="messages">Mensajes</div>
                                        <div class="tab-button" data-tab="apis">APIs</div>
                                        <div class="tab-button" data-tab="appointments">Citas</div>
                                        <div class="tab-button" data-tab="catalog">Cat√°logos</div>
                                        <div class="tab-button" data-tab="ai">IA & Palabras Clave</div>
                                        <div class="tab-button" data-tab="support">Atenci√≥n al Cliente</div>
                                        <div class="tab-button" data-tab="nlp">NLP</div>
                                        <div class="tab-button" data-tab="webhooks">Webhooks</div>
                                        <div class="tab-button" data-tab="code">C√≥digo</div>

                                    </div>


                                    <!-- Contenido de las pesta√±as -->
                                    <div class="flow-tab-content">
                                        <!-- Pesta√±a de diagrama -->
                                        <div class="tab-pane active" id="flowDiagramTab">
                                            <div class="flow-diagram-container">
                                                <div class="flow-diagram" id="flowDiagramCanvas">
                                                </div>

                                            </div>
                                            <div class="flow-diagram-toolbar">
                                                <button class="btn btn-sm btn-outline-secondary" onclick="zoomInFlow()">
                                                    <i class="fas fa-search-plus"></i> Zoom In
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary"
                                                    onclick="zoomOutFlow()">
                                                    <i class="fas fa-search-minus"></i> Zoom Out
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary"
                                                    onclick="resetFlowZoom()">
                                                    <i class="fas fa-sync"></i> Reset Zoom
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary"
                                                    onclick="saveFlowAsPNG()">
                                                    <i class="fas fa-download"></i> Guardar PNG
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary"
                                                    onclick="toggleProperties()">
                                                    <i class="fas fa-sliders-h"></i> Propiedades
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de pasos -->
                                        <div class="tab-pane" id="flowStepsTab">
                                            <div class="flow-steps-container">
                                                <div class="flow-steps-header">
                                                    <h5>Pasos del Flujo</h5>
                                                    <button class="btn btn-sm btn-primary" onclick="addFlowStep()">
                                                        <i class="fas fa-plus"></i> Agregar Paso
                                                    </button>
                                                </div>

                                                <div class="flow-step-editor" id="flowStepEditor">
                                                    <div class="step-editor-placeholder" id="stepEditorPlaceholder">
                                                        <p>Selecciona un paso para editarlo o crea uno nuevo</p>
                                                    </div>
                                                    <div class="step-edit-form" id="stepEditForm"
                                                        style="display: none;">
                                                        <h5>Editar Paso: <span id="currentStepName">INITIAL</span></h5>
                                                        <div class="form-group">
                                                            <label>Nombre del Paso</label>
                                                            <input type="text" class="form-control" id="stepName"
                                                                placeholder="Ej: INITIAL, AWAITING_CHOICE">
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Mensaje a Mostrar</label>
                                                            <textarea class="form-control" id="stepMessage" rows="4"
                                                                placeholder="Mensaje que se enviar√° al usuario en este paso"></textarea>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Siguiente Paso</label>
                                                            <select class="form-control" id="stepNextStep">
                                                                <option value="">Seleccionar siguiente paso</option>
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Condici√≥n (opcional)</label>
                                                            <input type="text" class="form-control" id="stepCondition"
                                                                placeholder="Condici√≥n para avanzar al siguiente paso">
                                                        </div>
                                                        <div class="step-actions">
                                                            <button class="btn btn-sm btn-success"
                                                                onclick="saveStepChanges()">
                                                                <i class="fas fa-save"></i> Guardar Cambios
                                                            </button>
                                                            <button class="btn btn-sm btn-danger"
                                                                onclick="deleteCurrentStep()">
                                                                <i class="fas fa-trash"></i> Eliminar Paso
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de opciones -->
                                        <div class="tab-pane" id="flowOptionsTab">
                                            <div class="flow-options-container">
                                                <div class="flow-options-header">
                                                    <h5>Opciones del Men√∫</h5>
                                                    <button class="btn btn-sm btn-primary" onclick="addFlowOption()">
                                                        <i class="fas fa-plus"></i> Agregar Opci√≥n
                                                    </button>
                                                </div>
                                                <div class="flow-options-list" id="flowOptionsList">
                                                    <!-- Opciones del flujo -->
                                                </div>
                                                <!-- Opci√≥n de edici√≥n como modal flotante -->
                                                <div class="modal-overlay" id="optionEditModal" style="display: none;">
                                                    <div class="modal-container">
                                                        <div class="modal-header">
                                                            <h5>Editar Opci√≥n: <span id="currentOptionNumber">1</span>
                                                            </h5>
                                                            <button type="button" class="modal-close"
                                                                onclick="closeOptionEditModal()">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form id="optionEditForm">
                                                                <div class="form-group">
                                                                    <label>N√∫mero/Emoji</label>
                                                                    <select class="form-control" id="optionEmoji">
                                                                        <option value="1Ô∏è‚É£">1Ô∏è‚É£ Uno</option>
                                                                        <option value="2Ô∏è‚É£">2Ô∏è‚É£ Dos</option>
                                                                        <option value="3Ô∏è‚É£">3Ô∏è‚É£ Tres</option>
                                                                        <option value="4Ô∏è‚É£">4Ô∏è‚É£ Cuatro</option>
                                                                        <option value="5Ô∏è‚É£">5Ô∏è‚É£ Cinco</option>
                                                                        <option value="6Ô∏è‚É£">6Ô∏è‚É£ Seis</option>
                                                                        <option value="7Ô∏è‚É£">7Ô∏è‚É£ Siete</option>
                                                                        <option value="8Ô∏è‚É£">8Ô∏è‚É£ Ocho</option>
                                                                        <option value="9Ô∏è‚É£">9Ô∏è‚É£ Nueve</option>
                                                                        <option value="üîç">üîç Buscar</option>
                                                                        <option value="üìÖ">üìÖ Calendario</option>
                                                                        <option value="üìã">üìã Lista</option>
                                                                        <option value="üí∞">üí∞ Precio</option>
                                                                        <option value="üìû">üìû Contacto</option>
                                                                        <option value="‚¨ÖÔ∏è">‚¨ÖÔ∏è Regresar</option>
                                                                        <option value="üè†">üè† Inicio</option>
                                                                    </select>
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>Texto de la Opci√≥n</label>
                                                                    <input type="text" class="form-control"
                                                                        id="optionText" placeholder="Ej: Ver Servicios">
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>Acci√≥n</label>
                                                                    <select class="form-control" id="optionAction"
                                                                        onchange="showActionValueOptions()">
                                                                        <option value="">Seleccionar acci√≥n</option>
                                                                        <option value="goToStep">Ir a otro paso</option>
                                                                        <option value="goToFlow">Ir a otro flujo
                                                                        </option>
                                                                        <option value="sendMessage">Enviar mensaje
                                                                        </option>
                                                                        <option value="sendMedia">Enviar multimedia
                                                                        </option>
                                                                        <option value="callAPI">Llamar API</option>
                                                                    </select>
                                                                </div>
                                                                <div class="form-group" id="optionActionValueContainer">
                                                                    <label>Valor de la Acci√≥n</label>
                                                                    <input type="text" class="form-control"
                                                                        id="optionActionValue"
                                                                        placeholder="Ej: MENU_SERVICIOS">
                                                                </div>

                                                                <!-- Vista previa de la opci√≥n -->
                                                                <div class="option-preview">
                                                                    <label>Vista Previa</label>
                                                                    <div class="option-preview-bubble">
                                                                        <span class="option-preview-emoji"
                                                                            id="previewEmoji">1Ô∏è‚É£</span>
                                                                        <span class="option-preview-text"
                                                                            id="previewText">Texto de ejemplo</span>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button class="btn btn-secondary"
                                                                onclick="closeOptionEditModal()">
                                                                <i class="fas fa-times"></i> Cancelar
                                                            </button>
                                                            <button class="btn btn-danger"
                                                                onclick="deleteCurrentOption()">
                                                                <i class="fas fa-trash"></i> Eliminar
                                                            </button>
                                                            <button class="btn btn-success"
                                                                onclick="saveOptionChanges()">
                                                                <i class="fas fa-save"></i> Guardar Cambios
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de mensajes -->
                                        <div class="tab-pane" id="flowMessagesTab">
                                            <div class="flow-messages-container">
                                                <div class="flow-messages-header">
                                                    <h5>Mensajes del Flujo</h5>
                                                    <button class="btn btn-sm btn-primary" onclick="addFlowMessage()">
                                                        <i class="fas fa-plus"></i> Agregar Mensaje
                                                    </button>
                                                </div>
                                                <div class="flow-messages-list" id="flowMessagesList">
                                                    <!-- Mensajes del flujo -->
                                                </div>
                                                <!-- Modal para editar mensajes -->
                                                <div class="modal-overlay" id="messageEditModal" style="display: none;">
                                                    <div class="modal-container message-modal">
                                                        <div class="modal-header">
                                                            <h5>Editar Mensaje: <span
                                                                    id="currentMessageKey">welcome</span></h5>
                                                            <button type="button" class="modal-close"
                                                                onclick="closeMessageEditModal()">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form id="messageEditForm">
                                                                <!-- Configuraci√≥n b√°sica -->
                                                                <div class="form-row">
                                                                    <div class="form-group col-md-6">
                                                                        <label>Clave del Mensaje <span
                                                                                class="required">*</span></label>
                                                                        <input type="text" class="form-control"
                                                                            id="messageKey"
                                                                            placeholder="Ej: welcome, error, success"
                                                                            required>
                                                                    </div>
                                                                    <div class="form-group col-md-6">
                                                                        <label>Tipo de Mensaje <span
                                                                                class="required">*</span></label>
                                                                        <select class="form-control" id="messageType"
                                                                            onchange="changeMessageType()">
                                                                            <option value="text">üìù Texto</option>
                                                                            <option value="image">üñºÔ∏è Imagen</option>
                                                                            <option value="video">üé• Video</option>
                                                                            <option value="audio">üéµ Audio</option>
                                                                            <option value="document">üìÑ Documento
                                                                            </option>
                                                                            <option value="location">üìç Ubicaci√≥n
                                                                            </option>
                                                                            <option value="contact">üë§ Contacto</option>
                                                                            <option value="buttons">üîò Botones
                                                                                Interactivos</option>
                                                                            <option value="list">üìã Lista de Opciones
                                                                            </option>
                                                                            <option value="template">üé® Plantilla
                                                                            </option>
                                                                        </select>
                                                                    </div>
                                                                </div>

                                                                <!-- Contenido principal -->
                                                                <div class="form-group">
                                                                    <label>Contenido del Mensaje <span
                                                                            class="required">*</span></label>
                                                                    <div class="message-content-editor">
                                                                        <textarea class="form-control"
                                                                            id="messageContent" rows="6"
                                                                            placeholder="Contenido del mensaje. Usa {{variable}} para variables din√°micas"></textarea>
                                                                        <div class="content-tools">
                                                                            <div class="content-tool-buttons">
                                                                                <button type="button"
                                                                                    class="btn btn-sm btn-outline-secondary"
                                                                                    onclick="insertEmoji()">
                                                                                    <i class="fas fa-smile"></i> Emoji
                                                                                </button>
                                                                                <button type="button"
                                                                                    class="btn btn-sm btn-outline-secondary"
                                                                                    onclick="insertVariable()">
                                                                                    <i class="fas fa-code"></i> Variable
                                                                                </button>
                                                                                <button type="button"
                                                                                    class="btn btn-sm btn-outline-secondary"
                                                                                    onclick="formatText('**', '**')">
                                                                                    <i class="fas fa-bold"></i>
                                                                                </button>
                                                                                <button type="button"
                                                                                    class="btn btn-sm btn-outline-secondary"
                                                                                    onclick="formatText('_', '_')">
                                                                                    <i class="fas fa-italic"></i>
                                                                                </button>
                                                                                <button type="button"
                                                                                    class="btn btn-sm btn-outline-secondary"
                                                                                    onclick="formatText('~', '~')">
                                                                                    <i class="fas fa-strikethrough"></i>
                                                                                </button>
                                                                                <button type="button"
                                                                                    class="btn btn-sm btn-outline-secondary"
                                                                                    onclick="formatText('\n- ', '')">
                                                                                    <i class="fas fa-list"></i>
                                                                                </button>
                                                                            </div>
                                                                            <span class="char-counter"
                                                                                id="charCounter">0/4096</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <!-- Campos espec√≠ficos por tipo -->
                                                                <div id="messageTypeFields">
                                                                    <!-- Se cargan din√°micamente seg√∫n el tipo -->
                                                                </div>

                                                                <!-- Variables disponibles -->
                                                                <div class="available-variables">
                                                                    <label>Variables Disponibles</label>
                                                                    <div class="variables-list">
                                                                        <span class="variable-tag"
                                                                            onclick="insertText('{{nombre}}')">{{nombre}}</span>
                                                                        <span class="variable-tag"
                                                                            onclick="insertText('{{fecha}}')">{{fecha}}</span>
                                                                        <span class="variable-tag"
                                                                            onclick="insertText('{{hora}}')">{{hora}}</span>
                                                                        <span class="variable-tag"
                                                                            onclick="insertText('{{empresa}}')">{{empresa}}</span>
                                                                        <span class="variable-tag"
                                                                            onclick="insertText('{{folio}}')">{{folio}}</span>
                                                                    </div>
                                                                </div>

                                                                <!-- Vista previa -->
                                                                <div class="message-preview-container"
                                                                    id="messagePreview">
                                                                    <label>Vista Previa</label>
                                                                    <div class="message-preview">
                                                                        <div class="chat-bubble bot" id="previewBubble">
                                                                            <!-- Vista previa del mensaje -->
                                                                        </div>
                                                                    </div>
                                                                    <div id="previewKeywords"
                                                                        class="preview-keywords-container"
                                                                        style="display: none;"></div>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button class="btn btn-secondary"
                                                                onclick="closeMessageEditModal()">
                                                                <i class="fas fa-times"></i> Cancelar
                                                            </button>
                                                            <button class="btn btn-danger"
                                                                onclick="deleteCurrentMessage()">
                                                                <i class="fas fa-trash"></i> Eliminar
                                                            </button>
                                                            <button class="btn btn-success"
                                                                onclick="saveMessageChanges()">
                                                                <i class="fas fa-save"></i> Guardar Cambios
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de APIs -->
                                        <div class="tab-pane" id="flowApisTab">
                                            <div class="flow-apis-container">
                                                <div class="flow-apis-header">
                                                    <h5>Configuraci√≥n de APIs</h5>
                                                    <button class="btn btn-sm btn-primary" onclick="addFlowApi()">
                                                        <i class="fas fa-plus"></i> Agregar API
                                                    </button>
                                                </div>
                                                <div class="flow-apis-list" id="flowApisList">
                                                    <!-- Las APIs se cargar√°n aqu√≠ -->
                                                </div>
                                                <!-- Modal para editar APIs -->
                                                <div class="modal-overlay" id="apiEditModal" style="display: none;">
                                                    <div class="modal-container api-modal">
                                                        <div class="modal-header">
                                                            <h5>Configurar API: <span id="currentApiName">Nueva
                                                                    API</span></h5>
                                                            <button type="button" class="modal-close"
                                                                onclick="closeApiEditModal()">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form id="apiEditForm">
                                                                <!-- Configuraci√≥n b√°sica -->
                                                                <div class="form-row">
                                                                    <div class="form-group col-md-6">
                                                                        <label>Nombre de la API <span
                                                                                class="required">*</span></label>
                                                                        <input type="text" class="form-control"
                                                                            id="apiName"
                                                                            placeholder="Ej: productosAPI, consultaCliente"
                                                                            required>
                                                                    </div>
                                                                    <div class="form-group col-md-6">
                                                                        <label>M√©todo <span
                                                                                class="required">*</span></label>
                                                                        <select class="form-control" id="apiMethod">
                                                                            <option value="GET">GET</option>
                                                                            <option value="POST">POST</option>
                                                                            <option value="PUT">PUT</option>
                                                                            <option value="DELETE">DELETE</option>
                                                                        </select>
                                                                    </div>
                                                                </div>

                                                                <!-- URL y autenticaci√≥n -->
                                                                <div class="form-group">
                                                                    <label>URL de la API <span
                                                                            class="required">*</span></label>
                                                                    <input type="url" class="form-control" id="apiUrl"
                                                                        placeholder="https://api.ejemplo.com/endpoint"
                                                                        required>
                                                                    <div class="format-hint">
                                                                        <i class="fas fa-info-circle"></i> Puedes usar
                                                                        variables en la URL con {{nombreVariable}}
                                                                    </div>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Autenticaci√≥n</label>
                                                                    <select class="form-control" id="apiAuth"
                                                                        onchange="toggleAuthFields()">
                                                                        <option value="none">Sin autenticaci√≥n</option>
                                                                        <option value="basic">Basic Auth</option>
                                                                        <option value="bearer">Bearer Token</option>
                                                                        <option value="apikey">API Key</option>
                                                                    </select>
                                                                </div>

                                                                <div id="authFieldsContainer" style="display: none;">
                                                                    <!-- Campos de autenticaci√≥n din√°micos -->
                                                                </div>

                                                                <!-- Headers -->
                                                                <div class="form-group">
                                                                    <label>Headers</label>
                                                                    <div id="apiHeadersContainer">
                                                                        <div class="header-row">
                                                                            <div class="input-group mb-2">
                                                                                <input type="text"
                                                                                    class="form-control header-key"
                                                                                    placeholder="Content-Type">
                                                                                <input type="text"
                                                                                    class="form-control header-value"
                                                                                    placeholder="application/json">
                                                                                <div class="input-group-append">
                                                                                    <button
                                                                                        class="btn btn-outline-danger"
                                                                                        type="button"
                                                                                        onclick="removeHeaderRow(this)">
                                                                                        <i class="fas fa-times"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <button type="button"
                                                                        class="btn btn-sm btn-outline-secondary"
                                                                        onclick="addHeaderRow()">
                                                                        <i class="fas fa-plus"></i> Agregar Header
                                                                    </button>
                                                                </div>

                                                                <!-- Cuerpo de la petici√≥n para POST/PUT -->
                                                                <div class="form-group" id="apiBodyContainer"
                                                                    style="display: none;">
                                                                    <label>Cuerpo de la Petici√≥n (JSON)</label>
                                                                    <textarea class="form-control code-editor"
                                                                        id="apiBody" rows="5"
                                                                        placeholder='{"key": "value", "user": "{{nombre}}"}'
                                                                        style="font-family: monospace;"></textarea>
                                                                    <div class="format-hint">
                                                                        <i class="fas fa-code"></i> Formato JSON con
                                                                        variables usando {{nombreVariable}}
                                                                    </div>
                                                                </div>

                                                                <!-- Gesti√≥n de respuesta -->
                                                                <div class="form-group">
                                                                    <label>Mapeo de Respuesta</label>
                                                                    <div class="response-mapping">
                                                                        <div class="form-row mb-2">
                                                                            <div class="col-5">
                                                                                <input type="text" class="form-control"
                                                                                    placeholder="Variable destino"
                                                                                    value="resultado">
                                                                            </div>
                                                                            <div class="col-7">
                                                                                <input type="text" class="form-control"
                                                                                    placeholder="Camino en JSON (ej: data.items[0].name)"
                                                                                    value="data">
                                                                            </div>
                                                                        </div>
                                                                        <button type="button"
                                                                            class="btn btn-sm btn-outline-secondary"
                                                                            onclick="addResponseMapping()">
                                                                            <i class="fas fa-plus"></i> Agregar Mapeo
                                                                        </button>
                                                                    </div>
                                                                </div>

                                                                <!-- Condiciones de uso -->
                                                                <div class="form-group">
                                                                    <label>¬øCu√°ndo llamar a esta API?</label>
                                                                    <select class="form-control" id="apiTrigger">
                                                                        <option value="manual">Manualmente (desde una
                                                                            opci√≥n)</option>
                                                                        <option value="step">Al entrar a un paso
                                                                            espec√≠fico</option>
                                                                        <option value="keyword">Al detectar palabra
                                                                            clave</option>
                                                                        <option value="variable">Al cambiar una variable
                                                                        </option>
                                                                    </select>
                                                                </div>

                                                                <div class="form-group" id="apiTriggerValueContainer">
                                                                    <label>Paso que dispara la API</label>
                                                                    <select class="form-control" id="apiTriggerValue">
                                                                        <option value="">Selecciona un paso</option>
                                                                        <!-- Los pasos se cargar√°n din√°micamente -->
                                                                    </select>
                                                                </div>

                                                                <!-- Test de la API -->
                                                                <div class="api-test-container">
                                                                    <button type="button" class="btn btn-info btn-sm"
                                                                        onclick="testApi()">
                                                                        <i class="fas fa-vial"></i> Probar API
                                                                    </button>
                                                                    <div class="api-test-result" id="apiTestResult"
                                                                        style="display: none;">
                                                                        <pre><code id="apiTestResponse"></code></pre>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button class="btn btn-secondary"
                                                                onclick="closeApiEditModal()">
                                                                <i class="fas fa-times"></i> Cancelar
                                                            </button>
                                                            <button class="btn btn-danger" onclick="deleteCurrentApi()">
                                                                <i class="fas fa-trash"></i> Eliminar
                                                            </button>
                                                            <button class="btn btn-success" onclick="saveApiChanges()">
                                                                <i class="fas fa-save"></i> Guardar Cambios
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de Citas -->
                                        <div class="tab-pane" id="flowAppointmentsTab">
                                            <div class="flow-appointments-container">
                                                <div class="flow-appointments-header">
                                                    <h5>Configuraci√≥n de Citas</h5>
                                                    <div class="appointment-status">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox"
                                                                id="appointmentsEnabled"
                                                                onchange="toggleAppointmentsEnabled(this.checked)">
                                                            <label class="form-check-label" for="appointmentsEnabled">
                                                                Sistema de citas habilitado
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="appointment-config-sections">
                                                    <!-- Secci√≥n 1: Configuraci√≥n general -->
                                                    <div class="appointment-config-section">
                                                        <h6><i class="fas fa-cog"></i> Configuraci√≥n General</h6>
                                                        <div class="form-row">
                                                            <div class="form-group col-md-6">
                                                                <label>Nombre del servicio</label>
                                                                <input type="text" class="form-control"
                                                                    id="appointmentServiceName"
                                                                    placeholder="Ej: Consulta m√©dica, Corte de cabello...">
                                                            </div>
                                                            <div class="form-group col-md-6">
                                                                <label>Duraci√≥n (minutos)</label>
                                                                <input type="number" class="form-control"
                                                                    id="appointmentDuration" min="5" step="5"
                                                                    value="30">
                                                            </div>
                                                        </div>

                                                        <div class="form-row">
                                                            <div class="form-group col-md-6">
                                                                <label>Tiempo m√≠nimo de anticipaci√≥n (horas)</label>
                                                                <input type="number" class="form-control"
                                                                    id="appointmentMinNotice" min="0" step="1"
                                                                    value="2">
                                                            </div>
                                                            <div class="form-group col-md-6">
                                                                <label>Tiempo m√°ximo de anticipaci√≥n (d√≠as)</label>
                                                                <input type="number" class="form-control"
                                                                    id="appointmentMaxNotice" min="1" step="1"
                                                                    value="30">
                                                            </div>
                                                        </div>

                                                        <div class="form-row">
                                                            <div class="form-group col-md-6">
                                                                <label>Pasos requeridos</label>
                                                                <select class="form-control"
                                                                    id="appointmentRequiredFields" multiple>
                                                                    <option value="name" selected>Nombre</option>
                                                                    <option value="phone" selected>Tel√©fono</option>
                                                                    <option value="email">Email</option>
                                                                    <option value="service">Servicio</option>
                                                                    <option value="comments">Comentarios</option>
                                                                </select>
                                                                <div class="format-hint">Ctrl+clic para seleccionar
                                                                    m√∫ltiples</div>
                                                            </div>
                                                            <div class="form-group col-md-6">
                                                                <label>Recordatorios</label>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        id="appointmentReminder24h">
                                                                    <label class="form-check-label"
                                                                        for="appointmentReminder24h">24 horas
                                                                        antes</label>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        id="appointmentReminder1h">
                                                                    <label class="form-check-label"
                                                                        for="appointmentReminder1h">1 hora antes</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n 2: Horarios disponibles -->
                                                    <div class="appointment-config-section">
                                                        <h6><i class="fas fa-calendar"></i> Horarios Disponibles</h6>
                                                        <div class="working-hours-container">
                                                            <table class="table table-sm">
                                                                <thead>
                                                                    <tr>
                                                                        <th>D√≠a</th>
                                                                        <th>Activo</th>
                                                                        <th>Hora inicio</th>
                                                                        <th>Hora fin</th>
                                                                        <th>Descanso</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="workingHoursTable">
                                                                    <tr data-day="monday">
                                                                        <td>Lunes</td>
                                                                        <td>
                                                                            <div class="form-check">
                                                                                <input
                                                                                    class="form-check-input day-active"
                                                                                    type="checkbox" checked>
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-start"
                                                                                value="09:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-end"
                                                                                value="18:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-start"
                                                                                value="13:00">
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-end"
                                                                                value="14:00">
                                                                        </td>
                                                                    </tr>
                                                                    <tr data-day="tuesday">
                                                                        <td>Martes</td>
                                                                        <td>
                                                                            <div class="form-check">
                                                                                <input
                                                                                    class="form-check-input day-active"
                                                                                    type="checkbox" checked>
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-start"
                                                                                value="09:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-end"
                                                                                value="18:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-start"
                                                                                value="13:00">
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-end"
                                                                                value="14:00">
                                                                        </td>
                                                                    </tr>
                                                                    <tr data-day="wednesday">
                                                                        <td>Mi√©rcoles</td>
                                                                        <td>
                                                                            <div class="form-check">
                                                                                <input
                                                                                    class="form-check-input day-active"
                                                                                    type="checkbox" checked>
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-start"
                                                                                value="09:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-end"
                                                                                value="18:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-start"
                                                                                value="13:00">
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-end"
                                                                                value="14:00">
                                                                        </td>
                                                                    </tr>
                                                                    <tr data-day="thursday">
                                                                        <td>Jueves</td>
                                                                        <td>
                                                                            <div class="form-check">
                                                                                <input
                                                                                    class="form-check-input day-active"
                                                                                    type="checkbox" checked>
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-start"
                                                                                value="09:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-end"
                                                                                value="18:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-start"
                                                                                value="13:00">
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-end"
                                                                                value="14:00">
                                                                        </td>
                                                                    </tr>
                                                                    <tr data-day="friday">
                                                                        <td>Viernes</td>
                                                                        <td>
                                                                            <div class="form-check">
                                                                                <input
                                                                                    class="form-check-input day-active"
                                                                                    type="checkbox" checked>
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-start"
                                                                                value="09:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-end"
                                                                                value="18:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-start"
                                                                                value="13:00">
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-end"
                                                                                value="14:00">
                                                                        </td>
                                                                    </tr>
                                                                    <tr data-day="saturday">
                                                                        <td>S√°bado</td>
                                                                        <td>
                                                                            <div class="form-check">
                                                                                <input
                                                                                    class="form-check-input day-active"
                                                                                    type="checkbox">
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-start"
                                                                                value="10:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-end"
                                                                                value="15:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-start"
                                                                                value="13:00">
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-end"
                                                                                value="13:30">
                                                                        </td>
                                                                    </tr>
                                                                    <tr data-day="sunday">
                                                                        <td>Domingo</td>
                                                                        <td>
                                                                            <div class="form-check">
                                                                                <input
                                                                                    class="form-check-input day-active"
                                                                                    type="checkbox">
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-start"
                                                                                value="10:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-end"
                                                                                value="15:00">
                                                                        </td>
                                                                        <td>
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-start"
                                                                                value="13:00">
                                                                            <input type="time"
                                                                                class="form-control form-control-sm day-break-end"
                                                                                value="13:30">
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>D√≠as festivos / No disponibles</label>
                                                            <div class="holidays-container" id="holidaysContainer">
                                                                <div class="holiday-item">
                                                                    <div class="input-group mb-2">
                                                                        <input type="date"
                                                                            class="form-control holiday-date">
                                                                        <input type="text"
                                                                            class="form-control holiday-description"
                                                                            placeholder="Descripci√≥n">
                                                                        <div class="input-group-append">
                                                                            <button class="btn btn-outline-danger"
                                                                                type="button"
                                                                                onclick="removeHoliday(this)">
                                                                                <i class="fas fa-times"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <button type="button"
                                                                class="btn btn-sm btn-outline-secondary"
                                                                onclick="addHoliday()">
                                                                <i class="fas fa-plus"></i> Agregar d√≠a no disponible
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n 3: Servicios disponibles -->
                                                    <div class="appointment-config-section">
                                                        <h6><i class="fas fa-concierge-bell"></i> Servicios Disponibles
                                                        </h6>
                                                        <div class="services-container" id="servicesContainer">
                                                            <div class="service-item">
                                                                <div class="input-group mb-2">
                                                                    <input type="text" class="form-control service-name"
                                                                        placeholder="Nombre del servicio">
                                                                    <input type="number"
                                                                        class="form-control service-duration"
                                                                        placeholder="Duraci√≥n (min)" min="5" step="5">
                                                                    <div class="input-group-append">
                                                                        <button class="btn btn-outline-danger"
                                                                            type="button" onclick="removeService(this)">
                                                                            <i class="fas fa-times"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                                            onclick="addService()">
                                                            <i class="fas fa-plus"></i> Agregar servicio
                                                        </button>
                                                    </div>

                                                    <!-- Secci√≥n 4: Mensajes y notificaciones -->
                                                    <div class="appointment-config-section">
                                                        <h6><i class="fas fa-comment-alt"></i> Mensajes y Notificaciones
                                                        </h6>
                                                        <div class="form-group">
                                                            <label>Mensaje de solicitud de cita</label>
                                                            <textarea class="form-control"
                                                                id="appointmentRequestMessage" rows="3">Por favor, proporciona la siguiente informaci√≥n para tu cita:
                                                                            1. Nombre completo
                                                                            2. Servicio requerido
                                                                            3. Fecha preferida (DD/MM/AAAA)
                                                                            4. Hora preferida</textarea>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Mensaje de confirmaci√≥n</label>
                                                            <textarea class="form-control"
                                                                id="appointmentConfirmMessage"
                                                                rows="3">‚úÖ Tu cita ha sido confirmada:
                                                                            üìÖ Fecha: {{fecha}}
                                                                            ‚è∞ Hora: {{hora}}
                                                                            üîñ Servicio: {{servicio}}
                                                                            üë§ A nombre de: {{nombre}}

                                                                            Para cancelar responde con la palabra "cancelar".</textarea>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Mensaje de recordatorio</label>
                                                            <textarea class="form-control"
                                                                id="appointmentReminderMessage"
                                                                rows="3">‚è∞ RECORDATORIO:
                                                                            Tienes una cita ma√±ana {{fecha}} a las {{hora}} para {{servicio}}.

                                                                            Te esperamos puntualmente. Si necesitas cancelar, responde "cancelar".</textarea>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n 5: Integraciones -->
                                                    <div class="appointment-config-section">
                                                        <h6><i class="fas fa-plug"></i> Integraciones de Calendario</h6>
                                                        <div class="calendar-integrations">
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="googleCalendarEnabled">
                                                                <label class="form-check-label"
                                                                    for="googleCalendarEnabled">
                                                                    Google Calendar
                                                                </label>
                                                            </div>
                                                            <div class="form-group" id="googleCalendarConfig"
                                                                style="display: none;">
                                                                <input type="text" class="form-control mb-2"
                                                                    placeholder="ID del calendario">
                                                                <input type="password" class="form-control mb-2"
                                                                    placeholder="Clave API">
                                                                <button type="button"
                                                                    class="btn btn-sm btn-outline-primary">
                                                                    <i class="fas fa-link"></i> Conectar cuenta
                                                                </button>
                                                            </div>

                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="outlookCalendarEnabled">
                                                                <label class="form-check-label"
                                                                    for="outlookCalendarEnabled">
                                                                    Microsoft Outlook
                                                                </label>
                                                            </div>
                                                            <div class="form-group" id="outlookCalendarConfig"
                                                                style="display: none;">
                                                                <input type="text" class="form-control mb-2"
                                                                    placeholder="ID de aplicaci√≥n">
                                                                <input type="password" class="form-control mb-2"
                                                                    placeholder="Clave secreta">
                                                                <button type="button"
                                                                    class="btn btn-sm btn-outline-primary">
                                                                    <i class="fas fa-link"></i> Conectar cuenta
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="appointment-save-actions">
                                                    <button class="btn btn-primary" onclick="saveAppointmentSettings()">
                                                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                                    </button>
                                                    <button class="btn btn-outline-secondary"
                                                        onclick="previewAppointmentFlow()">
                                                        <i class="fas fa-eye"></i> Vista Previa
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de Cat√°logos -->
                                        <div class="tab-pane" id="flowCatalogTab">
                                            <div class="flow-catalog-container">
                                                <div class="flow-catalog-header">
                                                    <h5>Cat√°logo de Productos y Servicios</h5>
                                                    <div class="catalog-type-selector">
                                                        <div class="btn-group" role="group">
                                                            <button type="button" class="btn btn-sm btn-primary active"
                                                                onclick="switchCatalogType('products')">
                                                                <i class="fas fa-shopping-cart"></i> Productos
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                                onclick="switchCatalogType('services')">
                                                                <i class="fas fa-concierge-bell"></i> Servicios
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                                onclick="switchCatalogType('menu')">
                                                                <i class="fas fa-utensils"></i> Men√∫
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Panel de Productos -->
                                                <div class="catalog-panel" id="productsCatalogPanel">
                                                    <div class="catalog-options">
                                                        <button class="btn btn-sm btn-outline-primary"
                                                            onclick="addCatalogCategory('products')">
                                                            <i class="fas fa-folder-plus"></i> Nueva Categor√≠a
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                            onclick="addCatalogItem('products')">
                                                            <i class="fas fa-plus"></i> Nuevo Producto
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                            onclick="importCatalog('products')">
                                                            <i class="fas fa-file-import"></i> Importar
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                            onclick="exportCatalog('products')">
                                                            <i class="fas fa-file-export"></i> Exportar
                                                        </button>
                                                    </div>

                                                    <div class="catalog-container">
                                                        <div class="catalog-sidebar">
                                                            <div class="sidebar-header">
                                                                <h6>Categor√≠as</h6>
                                                                <div class="search-box">
                                                                    <input type="text"
                                                                        class="form-control form-control-sm"
                                                                        placeholder="Buscar..."
                                                                        id="productCategorySearch">
                                                                    <i class="fas fa-search"></i>
                                                                </div>
                                                            </div>
                                                            <div class="catalog-categories" id="productCategories">
                                                                <div class="category-item active">
                                                                    <span>Todas las categor√≠as</span>
                                                                    <span class="badge bg-secondary"></span>
                                                                </div>
                                                                
                                                            </div>
                                                        </div>

                                                        <div class="catalog-content">
                                                            <div class="catalog-items" id="productItems">
                                                                <!-- Productos se cargar√°n aqu√≠ -->
                                                                
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Panel de Servicios -->
                                                <div class="catalog-panel" id="servicesCatalogPanel"
                                                    style="display: none;">
                                                    <div class="catalog-options">
                                                        <button class="btn btn-sm btn-outline-primary"
                                                            onclick="addCatalogCategory('services')">
                                                            <i class="fas fa-folder-plus"></i> Nueva Categor√≠a
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                            onclick="addCatalogItem('services')">
                                                            <i class="fas fa-plus"></i> Nuevo Servicio
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                            onclick="importCatalog('services')">
                                                            <i class="fas fa-file-import"></i> Importar
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                            onclick="exportCatalog('services')">
                                                            <i class="fas fa-file-export"></i> Exportar
                                                        </button>
                                                    </div>

                                                    <div class="catalog-container">
                                                        <div class="catalog-sidebar">
                                                            <div class="sidebar-header">
                                                                <h6>Categor√≠as</h6>
                                                                <div class="search-box">
                                                                    <input type="text"
                                                                        class="form-control form-control-sm"
                                                                        placeholder="Buscar..."
                                                                        id="serviceCategorySearch">
                                                                    <i class="fas fa-search"></i>
                                                                </div>
                                                            </div>
                                                            <div class="catalog-categories" id="serviceCategories">
                                                                <div class="category-item active">
                                                                    <span>Todos los servicios</span>
                                                                    <span class="badge bg-secondary"></span>
                                                                </div>
                                                                
                                                            </div>
                                                        </div>

                                                        <div class="catalog-content">
                                                            <div class="catalog-items" id="serviceItems">
                                                                <!-- Servicios se cargar√°n aqu√≠ -->
                                                                
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Panel de Men√∫ -->
                                                <div class="catalog-panel" id="menuCatalogPanel" style="display: none;">
                                                    <div class="catalog-options">
                                                        <button class="btn btn-sm btn-outline-primary"
                                                            onclick="addCatalogCategory('menu')">
                                                            <i class="fas fa-folder-plus"></i> Nueva Secci√≥n
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                            onclick="addCatalogItem('menu')">
                                                            <i class="fas fa-plus"></i> Nuevo Plato
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                            onclick="importCatalog('menu')">
                                                            <i class="fas fa-file-import"></i> Importar
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                            onclick="exportCatalog('menu')">
                                                            <i class="fas fa-file-export"></i> Exportar
                                                        </button>
                                                    </div>

                                                    <div class="catalog-container">
                                                        <div class="catalog-sidebar">
                                                            <div class="sidebar-header">
                                                                <h6>Secciones</h6>
                                                                <div class="search-box">
                                                                    <input type="text"
                                                                        class="form-control form-control-sm"
                                                                        placeholder="Buscar..." id="menuCategorySearch">
                                                                    <i class="fas fa-search"></i>
                                                                </div>
                                                            </div>
                                                            <div class="catalog-categories" id="menuCategories">
                                                                <div class="category-item active">
                                                                    <span>Men√∫ Completo</span>
                                                                    <span class="badge bg-secondary"></span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="catalog-content">
                                                            <div class="catalog-items" id="menuItems">
                                                                <!-- Platos se cargar√°n aqu√≠ -->
                                                                
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Modal para editar/a√±adir elemento del cat√°logo -->
                                                <div class="modal-overlay" id="catalogItemModal" style="display: none;">
                                                    <div class="modal-container catalog-item-modal">
                                                        <div class="modal-header">
                                                            <h5 id="catalogItemModalTitle">A√±adir Producto</h5>
                                                            <button type="button" class="modal-close"
                                                                onclick="closeCatalogItemModal()">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form id="catalogItemForm">
                                                                <div class="form-row">
                                                                    <div class="form-group col-md-8">
                                                                        <label>Nombre <span
                                                                                class="required">*</span></label>
                                                                        <input type="text" class="form-control"
                                                                            id="itemName" required>
                                                                    </div>
                                                                    <div class="form-group col-md-4">
                                                                        <label>Categor√≠a <span
                                                                                class="required">*</span></label>
                                                                        <select class="form-control" id="itemCategory"
                                                                            required>
                                                                            <option value="">Seleccionar...</option>
                                                                            <!-- Se cargar√° din√°micamente -->
                                                                        </select>
                                                                    </div>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Descripci√≥n</label>
                                                                    <textarea class="form-control" id="itemDescription"
                                                                        rows="3"></textarea>
                                                                </div>

                                                                <div class="form-row">
                                                                    <div class="form-group col-md-6">
                                                                        <label>Precio <span
                                                                                class="required">*</span></label>
                                                                        <div class="input-group">
                                                                            <div class="input-group-prepend">
                                                                                <span class="input-group-text">$</span>
                                                                            </div>
                                                                            <input type="number" class="form-control"
                                                                                id="itemPrice" step="0.01" required>
                                                                        </div>
                                                                    </div>
                                                                    <div class="form-group col-md-6">
                                                                        <label>Disponibilidad</label>
                                                                        <select class="form-control"
                                                                            id="itemAvailability">
                                                                            <option value="available">Disponible
                                                                            </option>
                                                                            <option value="limited">Existencias
                                                                                Limitadas</option>
                                                                            <option value="outofstock">Agotado</option>
                                                                        </select>
                                                                    </div>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Imagen</label>
                                                                    <div class="item-image-upload">
                                                                        <div class="current-image"
                                                                            id="itemImagePreview">
                                                                            <img src="https://via.placeholder.com/200"
                                                                                alt="Vista previa">
                                                                        </div>
                                                                        <div class="image-upload-controls">
                                                                            <input type="file" id="itemImageFile"
                                                                                accept="image/*" style="display: none;">
                                                                            <button type="button"
                                                                                class="btn btn-sm btn-outline-primary"
                                                                                onclick="document.getElementById('itemImageFile').click()">
                                                                                <i class="fas fa-upload"></i> Subir
                                                                                Imagen
                                                                            </button>
                                                                            <button type="button"
                                                                                class="btn btn-sm btn-outline-secondary"
                                                                                onclick="enterImageUrl()">
                                                                                <i class="fas fa-link"></i> URL
                                                                            </button>
                                                                        </div>
                                                                        <input type="hidden" id="itemImageUrl">
                                                                    </div>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Opciones adicionales</label>
                                                                    <div class="item-options" id="itemOptions">
                                                                        <!-- Se cargar√°n din√°micamente -->
                                                                    </div>
                                                                    <button type="button"
                                                                        class="btn btn-sm btn-outline-secondary"
                                                                        onclick="addItemOption()">
                                                                        <i class="fas fa-plus"></i> A√±adir Opci√≥n
                                                                    </button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button class="btn btn-secondary"
                                                                onclick="closeCatalogItemModal()">
                                                                <i class="fas fa-times"></i> Cancelar
                                                            </button>
                                                            <button class="btn btn-success" onclick="saveCatalogItem()">
                                                                <i class="fas fa-save"></i> Guardar
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Modal para categor√≠as -->
                                                <div class="modal-overlay" id="catalogCategoryModal"
                                                    style="display: none;">
                                                    <div class="modal-container catalog-category-modal">
                                                        <div class="modal-header">
                                                            <h5 id="catalogCategoryModalTitle">A√±adir Categor√≠a</h5>
                                                            <button type="button" class="modal-close"
                                                                onclick="closeCatalogCategoryModal()">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form id="catalogCategoryForm">
                                                                <div class="form-group">
                                                                    <label>Nombre de la Categor√≠a <span
                                                                            class="required">*</span></label>
                                                                    <input type="text" class="form-control"
                                                                        id="categoryName" required>
                                                                </div>
                                                                <div class="form-group">
                                                                    <label>Descripci√≥n</label>
                                                                    <textarea class="form-control"
                                                                        id="categoryDescription" rows="3"></textarea>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button class="btn btn-secondary"
                                                                onclick="closeCatalogCategoryModal()">
                                                                <i class="fas fa-times"></i> Cancelar
                                                            </button>
                                                            <button class="btn btn-success"
                                                                onclick="saveCatalogCategory()">
                                                                <i class="fas fa-save"></i> Guardar
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="catalog-save-actions">
                                                    <button class="btn btn-primary" onclick="saveCatalogSettings()">
                                                        <i class="fas fa-save"></i> Guardar Cat√°logo
                                                    </button>
                                                    <button class="btn btn-outline-secondary"
                                                        onclick="previewCatalogFlow()">
                                                        <i class="fas fa-eye"></i> Vista Previa
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de IA y Palabras Clave -->
                                        <div class="tab-pane" id="flowAiTab">
                                            <div class="flow-ai-container">
                                                <div class="flow-ai-header">
                                                    <h5>Inteligencia Artificial y Respuestas Autom√°ticas</h5>
                                                    <div class="ai-status">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox"
                                                                id="aiEnabled" onchange="toggleAiEnabled(this.checked)">
                                                            <label class="form-check-label" for="aiEnabled">
                                                                Respuestas inteligentes habilitadas
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="ai-container">
                                                    <!-- Secci√≥n de integraci√≥n IA -->
                                                    <div class="ai-section">
                                                        <h6><i class="fas fa-robot"></i> Configuraci√≥n de Inteligencia
                                                            Artificial</h6>

                                                        <div class="form-group">
                                                            <label>Modelo de IA</label>
                                                            <select class="form-control" id="aiModel">
                                                                <option value="openai">OpenAI (GPT)</option>
                                                                <option value="claude">Anthropic (Claude)</option>
                                                                <option value="huggingface">Hugging Face</option>
                                                                <option value="custom">API personalizada</option>
                                                            </select>
                                                        </div>

                                                        <div class="api-settings">
                                                            <div class="form-group">
                                                                <label>API Key <span class="required">*</span></label>
                                                                <input type="password" class="form-control"
                                                                    id="aiApiKey" placeholder="sk-...">
                                                            </div>

                                                            <div class="form-group" id="aiModelNameContainer">
                                                                <label>Nombre del modelo</label>
                                                                <input type="text" class="form-control" id="aiModelName"
                                                                    placeholder="gpt-4-turbo, claude-3-opus...">
                                                            </div>

                                                            <div class="form-group" id="aiCustomUrlContainer"
                                                                style="display: none;">
                                                                <label>URL de la API personalizada</label>
                                                                <input type="url" class="form-control" id="aiCustomUrl"
                                                                    placeholder="https://...">
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Instrucciones del sistema</label>
                                                            <textarea class="form-control" id="aiSystemPrompt" rows="4"
                                                                placeholder="Instrucciones para que la IA entienda su rol y c√≥mo responder...">Eres un asistente virtual amable y profesional para nuestra empresa. Tu objetivo es proporcionar informaci√≥n clara y precisa sobre nuestros productos y servicios. Mant√©n tus respuestas breves y concisas, idealmente no m√°s de 3 p√°rrafos. Cuando no sepas algo con certeza, ind√≠calo claramente y sugiere que el usuario contacte con un representante humano.</textarea>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Temperatura (creatividad)</label>
                                                            <div class="slider-container">
                                                                <input type="range" class="form-control-range"
                                                                    id="aiTemperature" min="0" max="1" step="0.1"
                                                                    value="0.7">
                                                                <div class="slider-value">0.7</div>
                                                            </div>
                                                            <div class="slider-labels">
                                                                <span>Preciso</span>
                                                                <span>Creativo</span>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Memoria de conversaci√≥n</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="aiMemoryEnabled" checked>
                                                                <label class="form-check-label"
                                                                    for="aiMemoryEnabled">Habilitar memoria de
                                                                    conversaci√≥n</label>
                                                            </div>
                                                            <div id="memorySettingsContainer">
                                                                <div class="form-row">
                                                                    <div class="form-group col-md-6">
                                                                        <label>Mensajes a recordar</label>
                                                                        <input type="number" class="form-control"
                                                                            id="aiMemoryMessages" min="1" max="20"
                                                                            value="10">
                                                                    </div>
                                                                    <div class="form-group col-md-6">
                                                                        <label>Duraci√≥n de la sesi√≥n (minutos)</label>
                                                                        <input type="number" class="form-control"
                                                                            id="aiSessionDuration" min="5" max="1440"
                                                                            value="30">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Prueba la IA</label>
                                                            <div class="ai-test-container">
                                                                <div class="test-conversation" id="aiTestConversation">
                                                                    <div class="test-message user">
                                                                        <div class="message-content">Hola, ¬øc√≥mo puedes
                                                                            ayudarme?</div>
                                                                    </div>
                                                                    <div class="test-message ai">
                                                                        <div class="message-content">¬°Hola! Soy el
                                                                            asistente virtual de la empresa. Puedo
                                                                            ayudarte con informaci√≥n sobre nuestros
                                                                            productos, servicios, horarios de atenci√≥n,
                                                                            o resolver dudas frecuentes. ¬øEn qu√© puedo
                                                                            asistirte hoy?</div>
                                                                    </div>
                                                                </div>
                                                                <div class="test-input">
                                                                    <input type="text" class="form-control"
                                                                        id="aiTestInput"
                                                                        placeholder="Escribe un mensaje para probar...">
                                                                    <button class="btn btn-primary"
                                                                        onclick="testAiResponse()">
                                                                        <i class="fas fa-paper-plane"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n de palabras clave -->
                                                    <div class="keywords-section">
                                                        <h6><i class="fas fa-key"></i> Palabras Clave y Respuestas
                                                            Autom√°ticas</h6>

                                                        <div class="form-group">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="keywordsEnabled" checked>
                                                                <label class="form-check-label"
                                                                    for="keywordsEnabled">Habilitar respuestas por
                                                                    palabras clave</label>
                                                            </div>
                                                        </div>

                                                        <div class="keywords-container" id="keywordsContainer">
                                                            <div class="keywords-table">
                                                                <div class="keywords-header">
                                                                    <div class="keyword-col">Palabra o frase</div>
                                                                    <div class="response-col">Respuesta autom√°tica</div>
                                                                    <div class="actions-col">Acciones</div>
                                                                </div>
                                                                <div class="keywords-body" id="keywordsList">
                                                                    <!-- Las palabras clave se cargar√°n aqu√≠ -->
                                                                    <div class="keyword-row">
                                                                        <div class="keyword-col">
                                                                            <input type="text" class="form-control"
                                                                                value="horario, horarios, abierto">
                                                                        </div>
                                                                        <div class="response-col">
                                                                            <textarea
                                                                                class="form-control">Nuestro horario de atenci√≥n es de lunes a viernes de 9:00 AM a 6:00 PM, y s√°bados de 10:00 AM a 2:00 PM. Domingos cerrado.</textarea>
                                                                        </div>
                                                                        <div class="actions-col">
                                                                            <button
                                                                                class="btn btn-sm btn-outline-danger"
                                                                                onclick="removeKeyword(this)">
                                                                                <i class="fas fa-trash"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div class="keyword-row">
                                                                        <div class="keyword-col">
                                                                            <input type="text" class="form-control"
                                                                                value="precio, precios, costo, costos">
                                                                        </div>
                                                                        <div class="response-col">
                                                                            <textarea
                                                                                class="form-control">Puedes consultar nuestros precios en el cat√°logo de productos. ¬øTe gustar√≠a que te muestre el cat√°logo?</textarea>
                                                                        </div>
                                                                        <div class="actions-col">
                                                                            <button
                                                                                class="btn btn-sm btn-outline-danger"
                                                                                onclick="removeKeyword(this)">
                                                                                <i class="fas fa-trash"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div class="keyword-row">
                                                                        <div class="keyword-col">
                                                                            <input type="text" class="form-control"
                                                                                value="ubicaci√≥n, direcci√≥n, donde, d√≥nde">
                                                                        </div>
                                                                        <div class="response-col">
                                                                            <textarea
                                                                                class="form-control">Estamos ubicados en Av. Principal #123, Colonia Centro. Puedes encontrarnos en Google Maps como "Nombre de la Empresa".</textarea>
                                                                        </div>
                                                                        <div class="actions-col">
                                                                            <button
                                                                                class="btn btn-sm btn-outline-danger"
                                                                                onclick="removeKeyword(this)">
                                                                                <i class="fas fa-trash"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <button class="btn btn-sm btn-outline-primary"
                                                                onclick="addKeyword()">
                                                                <i class="fas fa-plus"></i> A√±adir Palabra Clave
                                                            </button>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Opciones de coincidencia</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="keywordCaseSensitive">
                                                                <label class="form-check-label"
                                                                    for="keywordCaseSensitive">Sensible a
                                                                    may√∫sculas/min√∫sculas</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="keywordExactMatch">
                                                                <label class="form-check-label"
                                                                    for="keywordExactMatch">Coincidencia exacta (de lo
                                                                    contrario, parcial)</label>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Comportamiento cuando no hay coincidencias</label>
                                                            <select class="form-control" id="noMatchBehavior">
                                                                <option value="ai">Usar IA para responder</option>
                                                                <option value="default">Enviar mensaje predeterminado
                                                                </option>
                                                                <option value="human">Transferir a un asesor humano
                                                                </option>
                                                            </select>
                                                            <div class="form-group" id="defaultNoMatchContainer">
                                                                <label>Mensaje predeterminado</label>
                                                                <textarea class="form-control"
                                                                    id="defaultNoMatchMessage"
                                                                    rows="3">Lo siento, no he entendido tu consulta. ¬øPodr√≠as reformularla o ser m√°s espec√≠fico?</textarea>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n de transferencia a humano -->
                                                    <div class="human-handoff-section">
                                                        <h6><i class="fas fa-headset"></i> Transferencia a Asesor Humano
                                                        </h6>

                                                        <div class="form-group">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="humanHandoffEnabled" checked>
                                                                <label class="form-check-label"
                                                                    for="humanHandoffEnabled">Habilitar transferencia a
                                                                    humano</label>
                                                            </div>
                                                        </div>

                                                        <div id="humanHandoffSettings">
                                                            <div class="form-group">
                                                                <label>Palabras clave de activaci√≥n</label>
                                                                <input type="text" class="form-control"
                                                                    id="humanHandoffTriggers"
                                                                    placeholder="Separa las palabras con comas"
                                                                    value="asesor, agente, humano, persona, hablar, ayuda">
                                                                <div class="form-text text-muted">Si el usuario menciona
                                                                    estas palabras, se le ofrecer√° hablar con un asesor
                                                                    humano</div>
                                                            </div>

                                                            <div class="form-group">
                                                                <label>Mensaje de transferencia</label>
                                                                <textarea class="form-control" id="humanHandoffMessage"
                                                                    rows="3">Un momento por favor, estoy transfiriendo tu conversaci√≥n a un asesor humano. Pronto te atender√°.</textarea>
                                                            </div>

                                                            <div class="form-group">
                                                                <label>Mensaje de espera</label>
                                                                <textarea class="form-control"
                                                                    id="humanHandoffWaitMessage"
                                                                    rows="3">Gracias por tu paciencia. Nuestros asesores est√°n ocupados en este momento. Un asesor te atender√° en breve.</textarea>
                                                            </div>

                                                            <div class="form-group">
                                                                <label>Correo electr√≥nico para notificaciones</label>
                                                                <input type="email" class="form-control"
                                                                    id="humanHandoffEmail"
                                                                    placeholder="email@tuempresa.com">
                                                            </div>

                                                            <div class="form-group">
                                                                <label>Tiempo m√°ximo de espera (minutos)</label>
                                                                <input type="number" class="form-control"
                                                                    id="humanHandoffMaxWait" min="1" max="60" value="5">
                                                            </div>

                                                            <div class="form-group">
                                                                <label>Horario de atenci√≥n</label>
                                                                <div class="form-row">
                                                                    <div class="form-group col-md-6">
                                                                        <label>Desde</label>
                                                                        <input type="time" class="form-control"
                                                                            id="humanHandoffStartTime" value="09:00">
                                                                    </div>
                                                                    <div class="form-group col-md-6">
                                                                        <label>Hasta</label>
                                                                        <input type="time" class="form-control"
                                                                            id="humanHandoffEndTime" value="18:00">
                                                                    </div>
                                                                </div>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        id="humanHandoffWeekends">
                                                                    <label class="form-check-label"
                                                                        for="humanHandoffWeekends">Incluir fines de
                                                                        semana</label>
                                                                </div>
                                                            </div>

                                                            <div class="form-group">
                                                                <label>Mensaje fuera de horario</label>
                                                                <textarea class="form-control"
                                                                    id="humanHandoffOffHoursMessage"
                                                                    rows="3">Lo siento, nuestros asesores no est√°n disponibles en este momento. Nuestro horario de atenci√≥n es de lunes a viernes de 9:00 AM a 6:00 PM. ¬øPuedo ayudarte con algo m√°s mientras tanto?</textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="ai-save-actions">
                                                    <button class="btn btn-primary" onclick="saveAiSettings()">
                                                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                                    </button>
                                                    <button class="btn btn-outline-secondary"
                                                        onclick="generateAiFlowCode()">
                                                        <i class="fas fa-code"></i> Generar C√≥digo de Integraci√≥n
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de Atenci√≥n al Cliente -->
                                        <div class="tab-pane" id="flowSupportTab">
                                            <div class="flow-support-container">
                                                <div class="flow-support-header">
                                                    <h5>Configuraci√≥n de Atenci√≥n al Cliente</h5>
                                                    <div class="support-status">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox"
                                                                id="supportEnabled"
                                                                onchange="toggleSupportEnabled(this.checked)">
                                                            <label class="form-check-label" for="supportEnabled">
                                                                Sistema de atenci√≥n al cliente habilitado
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="support-container">
                                                    <!-- Secci√≥n de pausa de conversaci√≥n -->
                                                    <div class="support-section">
                                                        <h6><i class="fas fa-pause-circle"></i> Pausa de Conversaci√≥n
                                                        </h6>

                                                        <div class="form-group">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="pauseEnabled" checked>
                                                                <label class="form-check-label"
                                                                    for="pauseEnabled">Habilitar pausa de
                                                                    conversaci√≥n</label>
                                                            </div>
                                                            <div class="form-text text-muted">Permite que el bot pueda
                                                                pausarse para que un asesor humano intervenga</div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Palabras clave para pausar</label>
                                                            <input type="text" class="form-control" id="pauseTriggers"
                                                                placeholder="Separa las palabras con comas"
                                                                value="pausar, pausa, detener, espera, asesor, humano, ayuda">
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Mensaje al pausar</label>
                                                            <textarea class="form-control" id="pauseMessage"
                                                                rows="3">La conversaci√≥n ha sido pausada. Un asesor humano continuar√° la atenci√≥n en breve. Gracias por tu paciencia.</textarea>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Mensaje al reanudar</label>
                                                            <textarea class="form-control" id="resumeMessage"
                                                                rows="3">La conversaci√≥n automatizada se ha reanudado. ¬øEn qu√© m√°s puedo ayudarte?</textarea>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Duraci√≥n m√°xima de pausa (minutos)</label>
                                                            <input type="number" class="form-control"
                                                                id="maxPauseDuration" min="1" max="1440" value="60">
                                                            <div class="form-text text-muted">Si se supera este tiempo,
                                                                el bot retomar√° la conversaci√≥n autom√°ticamente</div>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n de panel de agentes -->
                                                    <div class="support-section">
                                                        <h6><i class="fas fa-headset"></i> Panel de Agentes</h6>

                                                        <div class="form-group">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="agentPanelEnabled" checked>
                                                                <label class="form-check-label"
                                                                    for="agentPanelEnabled">Habilitar panel de
                                                                    agentes</label>
                                                            </div>
                                                            <div class="form-text text-muted">Permite a los agentes ver
                                                                y administrar conversaciones pausadas</div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>URL del panel de agentes</label>
                                                            <div class="input-group">
                                                                <input type="text" class="form-control"
                                                                    id="agentPanelUrl"
                                                                    placeholder="https://tudominio.com/agent-panel"
                                                                    value="">
                                                                <div class="input-group-append">
                                                                    <button class="btn btn-outline-secondary"
                                                                        onclick="copyAgentPanelUrl()">
                                                                        <i class="fas fa-copy"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Configuraci√≥n de acceso</label>
                                                            <div class="form-row">
                                                                <div class="form-group col-md-6">
                                                                    <label>Nombre de usuario de administrador</label>
                                                                    <input type="text" class="form-control"
                                                                        id="agentAdminUsername" placeholder="admin">
                                                                </div>
                                                                <div class="form-group col-md-6">
                                                                    <label>Contrase√±a de administrador</label>
                                                                    <input type="password" class="form-control"
                                                                        id="agentAdminPassword"
                                                                        placeholder="Contrase√±a">
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Agentes</label>
                                                            <div class="agents-container" id="agentsContainer">
                                                                <div class="agent-row">
                                                                    <div class="agent-info">
                                                                        <input type="text"
                                                                            class="form-control agent-name"
                                                                            placeholder="Nombre del agente"
                                                                            value="Juan P√©rez">
                                                                        <input type="text"
                                                                            class="form-control agent-username"
                                                                            placeholder="Nombre de usuario"
                                                                            value="juanp">
                                                                        <input type="password"
                                                                            class="form-control agent-password"
                                                                            placeholder="Contrase√±a" value="password">
                                                                    </div>
                                                                    <div class="agent-status">
                                                                        <select class="form-control">
                                                                            <option value="active">Activo</option>
                                                                            <option value="inactive">Inactivo</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="agent-actions">
                                                                        <button class="btn btn-sm btn-outline-danger"
                                                                            onclick="removeAgent(this)">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <div class="agent-row">
                                                                    <div class="agent-info">
                                                                        <input type="text"
                                                                            class="form-control agent-name"
                                                                            placeholder="Nombre del agente"
                                                                            value="Mar√≠a G√≥mez">
                                                                        <input type="text"
                                                                            class="form-control agent-username"
                                                                            placeholder="Nombre de usuario"
                                                                            value="mariag">
                                                                        <input type="password"
                                                                            class="form-control agent-password"
                                                                            placeholder="Contrase√±a" value="password">
                                                                    </div>
                                                                    <div class="agent-status">
                                                                        <select class="form-control">
                                                                            <option value="active">Activo</option>
                                                                            <option value="inactive">Inactivo</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="agent-actions">
                                                                        <button class="btn btn-sm btn-outline-danger"
                                                                            onclick="removeAgent(this)">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <button class="btn btn-sm btn-outline-primary"
                                                                onclick="addAgent()">
                                                                <i class="fas fa-plus"></i> A√±adir Agente
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n de notificaciones -->
                                                    <div class="support-section">
                                                        <h6><i class="fas fa-bell"></i> Notificaciones</h6>

                                                        <div class="form-group">
                                                            <label>Notificaciones por correo</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="emailNotificationsEnabled" checked>
                                                                <label class="form-check-label"
                                                                    for="emailNotificationsEnabled">Enviar
                                                                    notificaciones por correo</label>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Correo electr√≥nico para notificaciones</label>
                                                            <input type="email" class="form-control"
                                                                id="notificationEmail"
                                                                placeholder="soporte@tuempresa.com">
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Eventos para notificar</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="notifyOnPause" checked>
                                                                <label class="form-check-label"
                                                                    for="notifyOnPause">Nueva pausa de
                                                                    conversaci√≥n</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="notifyOnHandoff" checked>
                                                                <label class="form-check-label"
                                                                    for="notifyOnHandoff">Transferencia a agente</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="notifyOnUrgent">
                                                                <label class="form-check-label"
                                                                    for="notifyOnUrgent">Conversaciones marcadas como
                                                                    urgentes</label>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Notificaciones push</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="pushNotificationsEnabled">
                                                                <label class="form-check-label"
                                                                    for="pushNotificationsEnabled">Habilitar
                                                                    notificaciones push</label>
                                                            </div>
                                                            <div class="form-text text-muted">Requiere configuraci√≥n
                                                                adicional en el panel de agentes</div>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n de informes y estad√≠sticas -->
                                                    <div class="support-section">
                                                        <h6><i class="fas fa-chart-line"></i> Informes y Estad√≠sticas
                                                        </h6>

                                                        <div class="form-group">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="reportsEnabled" checked>
                                                                <label class="form-check-label"
                                                                    for="reportsEnabled">Habilitar informes y
                                                                    estad√≠sticas</label>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>M√©tricas a incluir</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="metricConversations" checked>
                                                                <label class="form-check-label"
                                                                    for="metricConversations">N√∫mero total de
                                                                    conversaciones</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="metricPauses" checked>
                                                                <label class="form-check-label"
                                                                    for="metricPauses">N√∫mero de pausas</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="metricHandoffs" checked>
                                                                <label class="form-check-label"
                                                                    for="metricHandoffs">Transferencias a
                                                                    agentes</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="metricResponseTime" checked>
                                                                <label class="form-check-label"
                                                                    for="metricResponseTime">Tiempo promedio de
                                                                    respuesta</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="metricResolutionTime" checked>
                                                                <label class="form-check-label"
                                                                    for="metricResolutionTime">Tiempo promedio de
                                                                    resoluci√≥n</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="metricSatisfaction">
                                                                <label class="form-check-label"
                                                                    for="metricSatisfaction">Satisfacci√≥n del
                                                                    cliente</label>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Informes programados</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="scheduledReportsEnabled">
                                                                <label class="form-check-label"
                                                                    for="scheduledReportsEnabled">Enviar informes
                                                                    programados</label>
                                                            </div>
                                                            <div class="form-row">
                                                                <div class="form-group col-md-6">
                                                                    <label>Frecuencia</label>
                                                                    <select class="form-control" id="reportFrequency">
                                                                        <option value="daily">Diario</option>
                                                                        <option value="weekly" selected>Semanal</option>
                                                                        <option value="monthly">Mensual</option>
                                                                    </select>
                                                                </div>
                                                                <div class="form-group col-md-6">
                                                                    <label>Correo para informes</label>
                                                                    <input type="email" class="form-control"
                                                                        id="reportEmail"
                                                                        placeholder="informes@tuempresa.com">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="support-save-actions">
                                                    <button class="btn btn-primary" onclick="saveSupportSettings()">
                                                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                                    </button>
                                                    <button class="btn btn-outline-secondary"
                                                        onclick="generateSupportFlowCode()">
                                                        <i class="fas fa-code"></i> Generar C√≥digo de Integraci√≥n
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de NLP (Procesamiento de Lenguaje Natural) -->
                                        <div class="tab-pane" id="flowNlpTab">
                                            <div class="flow-nlp-container">
                                                <div class="flow-nlp-header">
                                                    <h5>Procesamiento de Lenguaje Natural (NLP)</h5>
                                                    <div class="nlp-status">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox"
                                                                id="nlpEnabled"
                                                                onchange="toggleNlpEnabled(this.checked)">
                                                            <label class="form-check-label" for="nlpEnabled">
                                                                Habilitar procesamiento de lenguaje natural
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="nlp-container">
                                                    <!-- Secci√≥n de configuraci√≥n de NLP -->
                                                    <div class="nlp-section">
                                                        <h6><i class="fas fa-brain"></i> Configuraci√≥n de NLP</h6>

                                                        <div class="form-group">
                                                            <label>Proveedor de NLP</label>
                                                            <select class="form-control" id="nlpProvider"
                                                                onchange="updateNlpProviderFields()">
                                                                <option value="dialogflow">Dialogflow (Google)</option>
                                                                <option value="wit">Wit.ai (Facebook)</option>
                                                                <option value="luis">LUIS (Microsoft)</option>
                                                                <option value="rasa">Rasa NLU</option>
                                                                <option value="custom">API personalizada</option>
                                                            </select>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>API Key <span class="required">*</span></label>
                                                            <input type="password" class="form-control" id="nlpApiKey"
                                                                placeholder="Clave de API">
                                                        </div>

                                                        <div class="form-group" id="nlpProjectIdContainer">
                                                            <label>ID del Proyecto</label>
                                                            <input type="text" class="form-control" id="nlpProjectId"
                                                                placeholder="ID del proyecto">
                                                        </div>

                                                        <div class="form-group" id="nlpCustomUrlContainer"
                                                            style="display: none;">
                                                            <label>URL de la API personalizada</label>
                                                            <input type="url" class="form-control" id="nlpCustomUrl"
                                                                placeholder="https://...">
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Idioma principal</label>
                                                            <select class="form-control" id="nlpLanguage">
                                                                <option value="es">Espa√±ol</option>
                                                                <option value="en">Ingl√©s</option>
                                                                <option value="pt">Portugu√©s</option>
                                                                <option value="fr">Franc√©s</option>
                                                                <option value="it">Italiano</option>
                                                                <option value="de">Alem√°n</option>
                                                            </select>
                                                        </div>

                                                        <div class="form-group">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="nlpMultiLanguage">
                                                                <label class="form-check-label"
                                                                    for="nlpMultiLanguage">Habilitar detecci√≥n
                                                                    autom√°tica de idioma</label>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Umbral de confianza (0-1)</label>
                                                            <div class="slider-container">
                                                                <input type="range" class="form-control-range"
                                                                    id="nlpConfidenceThreshold" min="0" max="1"
                                                                    step="0.05" value="0.6">
                                                                <div class="slider-value" id="nlpConfidenceValue">0.6
                                                                </div>
                                                            </div>
                                                            <div class="slider-labels">
                                                                <span>Flexible</span>
                                                                <span>Estricto</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n de intenciones -->
                                                    <div class="nlp-section">
                                                        <h6><i class="fas fa-bullseye"></i> Intenciones</h6>

                                                        <div class="form-group">
                                                            <div class="intents-container">
                                                                <div class="intents-table">
                                                                    <div class="intents-header">
                                                                        <div class="intent-name-col">Nombre de la
                                                                            intenci√≥n</div>
                                                                        <div class="intent-examples-col">Ejemplos de
                                                                            frases</div>
                                                                        <div class="intent-action-col">Acci√≥n</div>
                                                                        <div class="intent-actions-col">Opciones</div>
                                                                    </div>
                                                                    <div class="intents-body" id="intentsList">
                                                                        <!-- Las intenciones se cargar√°n aqu√≠ -->
                                                                        <div class="intent-row">
                                                                            <div class="intent-name-col">
                                                                                <input type="text" class="form-control"
                                                                                    value="saludo">
                                                                            </div>
                                                                            <div class="intent-examples-col">
                                                                                <textarea
                                                                                    class="form-control">Hola, Buenos d√≠as, Buenas tardes, Hola qu√© tal, Saludos</textarea>
                                                                            </div>
                                                                            <div class="intent-action-col">
                                                                                <select class="form-control">
                                                                                    <option value="sendMessage">Enviar
                                                                                        mensaje</option>
                                                                                    <option value="goToFlow">Ir a flujo
                                                                                    </option>
                                                                                    <option value="goToStep">Ir a paso
                                                                                    </option>
                                                                                </select>
                                                                                <input type="text"
                                                                                    class="form-control mt-2"
                                                                                    placeholder="Valor"
                                                                                    value="mensaje_saludo">
                                                                            </div>
                                                                            <div class="intent-actions-col">
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    onclick="removeIntent(this)">
                                                                                    <i class="fas fa-trash"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <div class="intent-row">
                                                                            <div class="intent-name-col">
                                                                                <input type="text" class="form-control"
                                                                                    value="consulta_precio">
                                                                            </div>
                                                                            <div class="intent-examples-col">
                                                                                <textarea
                                                                                    class="form-control">Cu√°nto cuesta, Cu√°l es el precio, Precio de, Valor de, Costo de</textarea>
                                                                            </div>
                                                                            <div class="intent-action-col">
                                                                                <select class="form-control">
                                                                                    <option value="sendMessage">Enviar
                                                                                        mensaje</option>
                                                                                    <option selected value="goToFlow">Ir
                                                                                        a flujo</option>
                                                                                    <option value="goToStep">Ir a paso
                                                                                    </option>
                                                                                </select>
                                                                                <input type="text"
                                                                                    class="form-control mt-2"
                                                                                    placeholder="Valor"
                                                                                    value="CATALOGO_PRODUCTOS">
                                                                            </div>
                                                                            <div class="intent-actions-col">
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    onclick="removeIntent(this)">
                                                                                    <i class="fas fa-trash"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <div class="intent-row">
                                                                            <div class="intent-name-col">
                                                                                <input type="text" class="form-control"
                                                                                    value="agendar_cita">
                                                                            </div>
                                                                            <div class="intent-examples-col">
                                                                                <textarea
                                                                                    class="form-control">Quiero una cita, Agendar cita, Reservar hora, Solicitar turno, Programar visita</textarea>
                                                                            </div>
                                                                            <div class="intent-action-col">
                                                                                <select class="form-control">
                                                                                    <option value="sendMessage">Enviar
                                                                                        mensaje</option>
                                                                                    <option selected value="goToFlow">Ir
                                                                                        a flujo</option>
                                                                                    <option value="goToStep">Ir a paso
                                                                                    </option>
                                                                                </select>
                                                                                <input type="text"
                                                                                    class="form-control mt-2"
                                                                                    placeholder="Valor"
                                                                                    value="AGENDA_CITAS">
                                                                            </div>
                                                                            <div class="intent-actions-col">
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    onclick="removeIntent(this)">
                                                                                    <i class="fas fa-trash"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <button class="btn btn-sm btn-outline-primary"
                                                                    onclick="addIntent()">
                                                                    <i class="fas fa-plus"></i> A√±adir Intenci√≥n
                                                                </button>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Intenci√≥n por defecto (fallback)</label>
                                                            <div class="input-group">
                                                                <select class="form-control" id="nlpFallbackAction">
                                                                    <option value="sendMessage">Enviar mensaje</option>
                                                                    <option value="goToFlow">Ir a flujo</option>
                                                                    <option value="goToStep">Ir a paso</option>
                                                                    <option value="useAI">Usar IA para responder
                                                                    </option>
                                                                </select>
                                                                <input type="text" class="form-control"
                                                                    id="nlpFallbackValue" placeholder="Valor">
                                                            </div>
                                                            <div class="form-text text-muted">Se usa cuando no se
                                                                reconoce ninguna intenci√≥n</div>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n de entidades -->
                                                    <div class="nlp-section">
                                                        <h6><i class="fas fa-tag"></i> Entidades</h6>

                                                        <div class="form-group">
                                                            <div class="entities-container">
                                                                <div class="entities-table">
                                                                    <div class="entities-header">
                                                                        <div class="entity-name-col">Nombre de la
                                                                            entidad</div>
                                                                        <div class="entity-type-col">Tipo</div>
                                                                        <div class="entity-values-col">Valores /
                                                                            Ejemplos</div>
                                                                        <div class="entity-actions-col">Opciones</div>
                                                                    </div>
                                                                    <div class="entities-body" id="entitiesList">
                                                                        <!-- Las entidades se cargar√°n aqu√≠ -->
                                                                        <div class="entity-row">
                                                                            <div class="entity-name-col">
                                                                                <input type="text" class="form-control"
                                                                                    value="producto">
                                                                            </div>
                                                                            <div class="entity-type-col">
                                                                                <select class="form-control">
                                                                                    <option value="list">Lista</option>
                                                                                    <option value="regex">Expresi√≥n
                                                                                        regular</option>
                                                                                    <option value="pattern">Patr√≥n
                                                                                    </option>
                                                                                    <option value="composite">Compuesta
                                                                                    </option>
                                                                                </select>
                                                                            </div>
                                                                            <div class="entity-values-col">
                                                                                <textarea
                                                                                    class="form-control">smartphone, laptop, tablet, auriculares, teclado, mouse</textarea>
                                                                            </div>
                                                                            <div class="entity-actions-col">
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    onclick="removeEntity(this)">
                                                                                    <i class="fas fa-trash"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <div class="entity-row">
                                                                            <div class="entity-name-col">
                                                                                <input type="text" class="form-control"
                                                                                    value="fecha">
                                                                            </div>
                                                                            <div class="entity-type-col">
                                                                                <select class="form-control">
                                                                                    <option value="list">Lista</option>
                                                                                    <option value="regex">Expresi√≥n
                                                                                        regular</option>
                                                                                    <option selected value="pattern">
                                                                                        Patr√≥n</option>
                                                                                    <option value="composite">Compuesta
                                                                                    </option>
                                                                                </select>
                                                                            </div>
                                                                            <div class="entity-values-col">
                                                                                <textarea
                                                                                    class="form-control">dd/mm/yyyy, dd-mm-yyyy, hoy, ma√±ana, pasado ma√±ana, pr√≥ximo lunes</textarea>
                                                                            </div>
                                                                            <div class="entity-actions-col">
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    onclick="removeEntity(this)">
                                                                                    <i class="fas fa-trash"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        <div class="entity-row">
                                                                            <div class="entity-name-col">
                                                                                <input type="text" class="form-control"
                                                                                    value="email">
                                                                            </div>
                                                                            <div class="entity-type-col">
                                                                                <select class="form-control">
                                                                                    <option value="list">Lista</option>
                                                                                    <option selected value="regex">
                                                                                        Expresi√≥n regular</option>
                                                                                    <option value="pattern">Patr√≥n
                                                                                    </option>
                                                                                    <option value="composite">Compuesta
                                                                                    </option>
                                                                                </select>
                                                                            </div>
                                                                            <div class="entity-values-col">
                                                                                <textarea
                                                                                    class="form-control">[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}</textarea>
                                                                            </div>
                                                                            <div class="entity-actions-col">
                                                                                <button
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    onclick="removeEntity(this)">
                                                                                    <i class="fas fa-trash"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <button class="btn btn-sm btn-outline-primary"
                                                                    onclick="addEntity()">
                                                                    <i class="fas fa-plus"></i> A√±adir Entidad
                                                                </button>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Entidades del sistema</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="entityDateTime" checked>
                                                                <label class="form-check-label"
                                                                    for="entityDateTime">Fecha y hora
                                                                    (@datetime)</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="entityLocation" checked>
                                                                <label class="form-check-label"
                                                                    for="entityLocation">Ubicaci√≥n (@location)</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="entityPerson" checked>
                                                                <label class="form-check-label"
                                                                    for="entityPerson">Persona (@person)</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="entityNumber" checked>
                                                                <label class="form-check-label"
                                                                    for="entityNumber">N√∫mero (@number)</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="entityEmail" checked>
                                                                <label class="form-check-label" for="entityEmail">Correo
                                                                    electr√≥nico (@email)</label>
                                                            </div>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="entityPhone" checked>
                                                                <label class="form-check-label"
                                                                    for="entityPhone">Tel√©fono (@phone)</label>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n de pruebas de NLP -->
                                                    <div class="nlp-section">
                                                        <h6><i class="fas fa-flask"></i> Pruebas de NLP</h6>

                                                        <div class="form-group">
                                                            <label>Probar reconocimiento de intenci√≥n</label>
                                                            <div class="nlp-test-container">
                                                                <div class="test-input">
                                                                    <input type="text" class="form-control"
                                                                        id="nlpTestInput"
                                                                        placeholder="Escribe un mensaje para probar...">
                                                                    <button class="btn btn-primary"
                                                                        onclick="testNlpIntent()">
                                                                        <i class="fas fa-play"></i> Probar
                                                                    </button>
                                                                </div>
                                                                <div class="nlp-test-result" id="nlpTestResult"
                                                                    style="display: none;">
                                                                    <div class="result-card">
                                                                        <div class="result-header">Resultado del
                                                                            an√°lisis</div>
                                                                        <div class="result-body">
                                                                            <div class="result-item">
                                                                                <div class="result-label">Intenci√≥n
                                                                                    detectada:</div>
                                                                                <div class="result-value"
                                                                                    id="detectedIntent">-</div>
                                                                                <div class="confidence-bar">
                                                                                    <div class="confidence-level"
                                                                                        id="intentConfidence"
                                                                                        style="width: 0%;">0%</div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="result-item">
                                                                                <div class="result-label">Entidades
                                                                                    detectadas:</div>
                                                                                <div class="result-value entities"
                                                                                    id="detectedEntities">
                                                                                    <span
                                                                                        class="no-entities">Ninguna</span>
                                                                                </div>
                                                                            </div>
                                                                            <div class="result-item">
                                                                                <div class="result-label">Acci√≥n:</div>
                                                                                <div class="result-value"
                                                                                    id="intentAction">-</div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label>Entrenar modelo</label>
                                                            <p class="text-muted">Despu√©s de a√±adir o modificar
                                                                intenciones y entidades, debes entrenar el modelo para
                                                                que los cambios surtan efecto.</p>
                                                            <button class="btn btn-primary" id="trainButton"
                                                                onclick="trainNlpModel()">
                                                                <i class="fas fa-cogs"></i> Entrenar modelo
                                                            </button>
                                                            <div class="training-status" id="trainingStatus"
                                                                style="display: none;">
                                                                <div class="spinner"></div>
                                                                <span>Entrenando modelo... Por favor espera.</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="nlp-save-actions">
                                                    <button class="btn btn-primary" onclick="saveNlpSettings()">
                                                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                                    </button>
                                                    <button class="btn btn-outline-secondary"
                                                        onclick="generateNlpFlowCode()">
                                                        <i class="fas fa-code"></i> Generar C√≥digo de Integraci√≥n
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de Webhooks e Integraciones -->
                                        <div class="tab-pane" id="flowWebhooksTab">
                                            <div class="flow-webhooks-container">
                                                <div class="flow-webhooks-header">
                                                    <h5>Webhooks e Integraciones Externas</h5>
                                                    <div class="webhooks-status">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox"
                                                                id="webhooksEnabled"
                                                                onchange="toggleWebhooksEnabled(this.checked)">
                                                            <label class="form-check-label" for="webhooksEnabled">
                                                                Habilitar webhooks e integraciones
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="webhooks-container">
                                                    <!-- Secci√≥n de webhooks salientes -->
                                                    <div class="webhooks-section">
                                                        <h6><i class="fas fa-arrow-right"></i> Webhooks Salientes</h6>

                                                        <div class="form-group">
                                                            <p class="text-muted">Los webhooks salientes permiten enviar
                                                                notificaciones a sistemas externos cuando ocurren
                                                                eventos en tus flujos de conversaci√≥n.</p>
                                                        </div>

                                                        <div class="webhooks-list-container">
                                                            <div class="webhooks-table">
                                                                <div class="webhooks-header">
                                                                    <div class="webhook-event-col">Evento</div>
                                                                    <div class="webhook-url-col">URL del Webhook</div>
                                                                    <div class="webhook-method-col">M√©todo</div>
                                                                    <div class="webhook-actions-col">Opciones</div>
                                                                </div>
                                                                <div class="webhooks-body" id="outgoingWebhooksList">
                                                                    <!-- Los webhooks se cargar√°n aqu√≠ -->
                                                                    <div class="webhook-row">
                                                                        <div class="webhook-event-col">
                                                                            <select class="form-control">
                                                                                <option value="message_received">Mensaje
                                                                                    recibido</option>
                                                                                <option value="message_sent">Mensaje
                                                                                    enviado</option>
                                                                                <option value="conversation_started">
                                                                                    Conversaci√≥n iniciada</option>
                                                                                <option value="conversation_ended">
                                                                                    Conversaci√≥n finalizada</option>
                                                                                <option value="step_changed">Cambio de
                                                                                    paso</option>
                                                                                <option value="flow_changed">Cambio de
                                                                                    flujo</option>
                                                                            </select>
                                                                        </div>
                                                                        <div class="webhook-url-col">
                                                                            <input type="url" class="form-control"
                                                                                value="https://ejemplo.com/webhook/message">
                                                                        </div>
                                                                        <div class="webhook-method-col">
                                                                            <select class="form-control">
                                                                                <option value="POST">POST</option>
                                                                                <option value="GET">GET</option>
                                                                                <option value="PUT">PUT</option>
                                                                            </select>
                                                                        </div>
                                                                        <div class="webhook-actions-col">
                                                                            <button
                                                                                class="btn btn-sm btn-outline-primary"
                                                                                onclick="configureWebhook(this)">
                                                                                <i class="fas fa-cog"></i>
                                                                            </button>
                                                                            <button
                                                                                class="btn btn-sm btn-outline-danger"
                                                                                onclick="removeWebhook(this)">
                                                                                <i class="fas fa-trash"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div class="webhook-row">
                                                                        <div class="webhook-event-col">
                                                                            <select class="form-control">
                                                                                <option value="message_received">Mensaje
                                                                                    recibido</option>
                                                                                <option value="message_sent">Mensaje
                                                                                    enviado</option>
                                                                                <option value="conversation_started">
                                                                                    Conversaci√≥n iniciada</option>
                                                                                <option selected
                                                                                    value="conversation_ended">
                                                                                    Conversaci√≥n finalizada</option>
                                                                                <option value="step_changed">Cambio de
                                                                                    paso</option>
                                                                                <option value="flow_changed">Cambio de
                                                                                    flujo</option>
                                                                            </select>
                                                                        </div>
                                                                        <div class="webhook-url-col">
                                                                            <input type="url" class="form-control"
                                                                                value="https://ejemplo.com/webhook/conversation">
                                                                        </div>
                                                                        <div class="webhook-method-col">
                                                                            <select class="form-control">
                                                                                <option value="POST">POST</option>
                                                                                <option value="GET">GET</option>
                                                                                <option value="PUT">PUT</option>
                                                                            </select>
                                                                        </div>
                                                                        <div class="webhook-actions-col">
                                                                            <button
                                                                                class="btn btn-sm btn-outline-primary"
                                                                                onclick="configureWebhook(this)">
                                                                                <i class="fas fa-cog"></i>
                                                                            </button>
                                                                            <button
                                                                                class="btn btn-sm btn-outline-danger"
                                                                                onclick="removeWebhook(this)">
                                                                                <i class="fas fa-trash"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <button class="btn btn-sm btn-outline-primary"
                                                                onclick="addOutgoingWebhook()">
                                                                <i class="fas fa-plus"></i> A√±adir Webhook Saliente
                                                            </button>
                                                        </div>

                                                        <div class="form-group mt-3">
                                                            <label>Opciones de seguridad</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="webhookSecretEnabled" checked>
                                                                <label class="form-check-label"
                                                                    for="webhookSecretEnabled">Firmar peticiones con una
                                                                    clave secreta</label>
                                                            </div>
                                                            <div class="input-group mt-2" id="webhookSecretContainer">
                                                                <input type="text" class="form-control"
                                                                    id="webhookSecret" placeholder="Clave secreta"
                                                                    value="my_webhook_secret_1234">
                                                                <div class="input-group-append">
                                                                    <button class="btn btn-outline-secondary"
                                                                        onclick="generateWebhookSecret()">
                                                                        <i class="fas fa-sync"></i> Generar
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="form-group mt-3">
                                                            <label>Opciones avanzadas</label>
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                    id="webhookRetryEnabled" checked>
                                                                <label class="form-check-label"
                                                                    for="webhookRetryEnabled">Reintentar webhooks
                                                                    fallidos</label>
                                                            </div>
                                                            <div class="form-row mt-2" id="webhookRetryContainer">
                                                                <div class="form-group col-md-6">
                                                                    <label>N√∫mero de reintentos</label>
                                                                    <input type="number" class="form-control"
                                                                        id="webhookRetryCount" min="1" max="10"
                                                                        value="3">
                                                                </div>
                                                                <div class="form-group col-md-6">
                                                                    <label>Intervalo entre reintentos (segundos)</label>
                                                                    <input type="number" class="form-control"
                                                                        id="webhookRetryInterval" min="5" max="300"
                                                                        value="60">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n de webhooks entrantes -->
                                                    <div class="webhooks-section">
                                                        <h6><i class="fas fa-arrow-left"></i> Webhooks Entrantes</h6>

                                                        <div class="form-group">
                                                            <p class="text-muted">Los webhooks entrantes permiten que
                                                                sistemas externos inicien acciones en tus flujos de
                                                                conversaci√≥n.</p>
                                                        </div>

                                                        <div class="incoming-webhooks-container">
                                                            <div class="form-group">
                                                                <label>URL para webhooks entrantes</label>
                                                                <div class="input-group">
                                                                    <input type="text" class="form-control"
                                                                        id="incomingWebhookUrl" readonly
                                                                        value="https://tudominio.com/api/webhook/incoming/abcd1234">
                                                                    <div class="input-group-append">
                                                                        <button class="btn btn-outline-secondary"
                                                                            onclick="copyIncomingWebhookUrl()">
                                                                            <i class="fas fa-copy"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <div class="form-text text-muted">Configura sistemas
                                                                    externos para enviar datos a esta URL</div>
                                                            </div>

                                                            <div class="form-group">
                                                                <label>Acciones disponibles</label>
                                                                <div class="incoming-actions-list"
                                                                    id="incomingActionsList">
                                                                    <div class="action-row">
                                                                        <div class="action-key-col">
                                                                            <input type="text" class="form-control"
                                                                                value="send_message">
                                                                        </div>
                                                                        <div class="action-description-col">
                                                                            <input type="text" class="form-control"
                                                                                value="Enviar un mensaje a un usuario">
                                                                        </div>
                                                                        <div class="action-enabled-col">
                                                                            <div class="form-check">
                                                                                <input class="form-check-input"
                                                                                    type="checkbox" checked>
                                                                            </div>
                                                                        </div>
                                                                        <div class="action-actions-col">
                                                                            <button
                                                                                class="btn btn-sm btn-outline-primary"
                                                                                onclick="configureAction(this)">
                                                                                <i class="fas fa-cog"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div class="action-row">
                                                                        <div class="action-key-col">
                                                                            <input type="text" class="form-control"
                                                                                value="start_flow">
                                                                        </div>
                                                                        <div class="action-description-col">
                                                                            <input type="text" class="form-control"
                                                                                value="Iniciar un flujo espec√≠fico">
                                                                        </div>
                                                                        <div class="action-enabled-col">
                                                                            <div class="form-check">
                                                                                <input class="form-check-input"
                                                                                    type="checkbox" checked>
                                                                            </div>
                                                                        </div>
                                                                        <div class="action-actions-col">
                                                                            <button
                                                                                class="btn btn-sm btn-outline-primary"
                                                                                onclick="configureAction(this)">
                                                                                <i class="fas fa-cog"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div class="action-row">
                                                                        <div class="action-key-col">
                                                                            <input type="text" class="form-control"
                                                                                value="update_variable">
                                                                        </div>
                                                                        <div class="action-description-col">
                                                                            <input type="text" class="form-control"
                                                                                value="Actualizar una variable de sesi√≥n">
                                                                        </div>
                                                                        <div class="action-enabled-col">
                                                                            <div class="form-check">
                                                                                <input class="form-check-input"
                                                                                    type="checkbox" checked>
                                                                            </div>
                                                                        </div>
                                                                        <div class="action-actions-col">
                                                                            <button
                                                                                class="btn btn-sm btn-outline-primary"
                                                                                onclick="configureAction(this)">
                                                                                <i class="fas fa-cog"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <button class="btn btn-sm btn-outline-primary mt-2"
                                                                    onclick="addIncomingAction()">
                                                                    <i class="fas fa-plus"></i> A√±adir Acci√≥n
                                                                </button>
                                                            </div>

                                                            <div class="form-group mt-3">
                                                                <label>Seguridad del webhook entrante</label>
                                                                <select class="form-control"
                                                                    id="incomingWebhookSecurity">
                                                                    <option value="none">Sin autenticaci√≥n</option>
                                                                    <option value="token" selected>Token de
                                                                        autenticaci√≥n</option>
                                                                    <option value="hmac">Firma HMAC</option>
                                                                    <option value="basic">Autenticaci√≥n b√°sica</option>
                                                                </select>
                                                            </div>

                                                            <div class="form-group" id="incomingSecurityTokenContainer">
                                                                <label>Token de autenticaci√≥n</label>
                                                                <div class="input-group">
                                                                    <input type="text" class="form-control"
                                                                        id="incomingSecurityToken"
                                                                        value="incoming_webhook_token_5678">
                                                                    <div class="input-group-append">
                                                                        <button class="btn btn-outline-secondary"
                                                                            onclick="generateIncomingToken()">
                                                                            <i class="fas fa-sync"></i> Generar
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <div class="form-text text-muted">Incluye este token
                                                                    como header X-Auth-Token en las peticiones entrantes
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Secci√≥n de integraciones externas -->
                                                    <div class="webhooks-section">
                                                        <h6><i class="fas fa-plug"></i> Integraciones Externas</h6>

                                                        <div class="form-group">
                                                            <p class="text-muted">Conecta tu bot con servicios de
                                                                terceros para extender sus funcionalidades.</p>
                                                        </div>

                                                        <div class="integrations-list">
                                                            <div class="integration-card">
                                                                <div class="integration-icon">
                                                                    <i class="fab fa-google"></i>
                                                                </div>
                                                                <div class="integration-details">
                                                                    <h5>Google Sheets</h5>
                                                                    <p>Guarda datos de conversaciones en hojas de
                                                                        c√°lculo</p>
                                                                    <div class="integration-status">
                                                                        <span class="badge bg-secondary">No
                                                                            conectado</span>
                                                                        <button class="btn btn-sm btn-outline-primary"
                                                                            onclick="configureIntegration('google_sheets')">Configurar</button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="integration-card">
                                                                <div class="integration-icon">
                                                                    <i class="fab fa-hubspot"></i>
                                                                </div>
                                                                <div class="integration-details">
                                                                    <h5>HubSpot</h5>
                                                                    <p>Sincroniza contactos y conversaciones con HubSpot
                                                                        CRM</p>
                                                                    <div class="integration-status">
                                                                        <span class="badge bg-success">Conectado</span>
                                                                        <button class="btn btn-sm btn-outline-primary"
                                                                            onclick="configureIntegration('hubspot')">Configurar</button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="integration-card">
                                                                <div class="integration-icon">
                                                                    <i class="fab fa-slack"></i>
                                                                </div>
                                                                <div class="integration-details">
                                                                    <h5>Slack</h5>
                                                                    <p>Recibe notificaciones de conversaciones en Slack
                                                                    </p>
                                                                    <div class="integration-status">
                                                                        <span class="badge bg-secondary">No
                                                                            conectado</span>
                                                                        <button class="btn btn-sm btn-outline-primary"
                                                                            onclick="configureIntegration('slack')">Configurar</button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="integration-card">
                                                                <div class="integration-icon">
                                                                    <i class="fab fa-zapier"></i>
                                                                </div>
                                                                <div class="integration-details">
                                                                    <h5>Zapier</h5>
                                                                    <p>Conecta con miles de aplicaciones a trav√©s de
                                                                        Zapier</p>
                                                                    <div class="integration-status">
                                                                        <span class="badge bg-secondary">No
                                                                            conectado</span>
                                                                        <button class="btn btn-sm btn-outline-primary"
                                                                            onclick="configureIntegration('zapier')">Configurar</button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="integration-card">
                                                                <div class="integration-icon">
                                                                    <i class="fas fa-shopping-cart"></i>
                                                                </div>
                                                                <div class="integration-details">
                                                                    <h5>WooCommerce</h5>
                                                                    <p>Integraci√≥n con tu tienda WooCommerce</p>
                                                                    <div class="integration-status">
                                                                        <span class="badge bg-secondary">No
                                                                            conectado</span>
                                                                        <button class="btn btn-sm btn-outline-primary"
                                                                            onclick="configureIntegration('woocommerce')">Configurar</button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="integration-card">
                                                                <div class="integration-icon">
                                                                    <i class="fas fa-clipboard-list"></i>
                                                                </div>
                                                                <div class="integration-details">
                                                                    <h5>Google Forms</h5>
                                                                    <p>Enviar datos a formularios de Google</p>
                                                                    <div class="integration-status">
                                                                        <span class="badge bg-secondary">No
                                                                            conectado</span>
                                                                        <button class="btn btn-sm btn-outline-primary"
                                                                            onclick="configureIntegration('google_forms')">Configurar</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="add-integration-container mt-3">
                                                            <button class="btn btn-outline-primary"
                                                                onclick="browseIntegrations()">
                                                                <i class="fas fa-plus"></i> A√±adir Integraci√≥n
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Modal para configurar webhook -->
                                                <div class="modal-overlay" id="webhookConfigModal"
                                                    style="display: none;">
                                                    <div class="modal-container webhook-config-modal">
                                                        <div class="modal-header">
                                                            <h5 id="webhookModalTitle">Configurar Webhook</h5>
                                                            <button type="button" class="modal-close"
                                                                onclick="closeWebhookModal()">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form id="webhookConfigForm">
                                                                <div class="form-group">
                                                                    <label>Headers</label>
                                                                    <div id="webhookHeadersContainer">
                                                                        <div class="header-row">
                                                                            <div class="input-group mb-2">
                                                                                <input type="text"
                                                                                    class="form-control header-key"
                                                                                    placeholder="Content-Type"
                                                                                    value="Content-Type">
                                                                                <input type="text"
                                                                                    class="form-control header-value"
                                                                                    placeholder="application/json"
                                                                                    value="application/json">
                                                                                <div class="input-group-append">
                                                                                    <button
                                                                                        class="btn btn-outline-danger"
                                                                                        type="button"
                                                                                        onclick="removeHeaderRow(this)">
                                                                                        <i class="fas fa-times"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="header-row">
                                                                            <div class="input-group mb-2">
                                                                                <input type="text"
                                                                                    class="form-control header-key"
                                                                                    placeholder="Authorization"
                                                                                    value="Authorization">
                                                                                <input type="text"
                                                                                    class="form-control header-value"
                                                                                    placeholder="Bearer token123"
                                                                                    value="Bearer token123">
                                                                                <div class="input-group-append">
                                                                                    <button
                                                                                        class="btn btn-outline-danger"
                                                                                        type="button"
                                                                                        onclick="removeHeaderRow(this)">
                                                                                        <i class="fas fa-times"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <button type="button"
                                                                        class="btn btn-sm btn-outline-secondary"
                                                                        onclick="addWebhookHeader()">
                                                                        <i class="fas fa-plus"></i> A√±adir Header
                                                                    </button>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Formato del Payload</label>
                                                                    <select class="form-control"
                                                                        id="webhookPayloadFormat">
                                                                        <option value="json">JSON</option>
                                                                        <option value="form">Form Data</option>
                                                                        <option value="xml">XML</option>
                                                                    </select>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Plantilla de Payload</label>
                                                                    <textarea class="form-control"
                                                                        id="webhookPayloadTemplate" rows="8"
                                                                        style="font-family: monospace;">{
  "event": "{{event}}",
  "timestamp": "{{timestamp}}",
  "conversation": {
    "id": "{{conversation_id}}",
    "user": "{{user_id}}",
    "step": "{{current_step}}",
    "flow": "{{current_flow}}"
  },
  "message": {
    "text": "{{message_text}}",
    "type": "{{message_type}}"
  }
}</textarea>
                                                                    <div class="form-text text-muted">
                                                                        Usa {{variable}} para insertar valores din√°micos
                                                                        en el payload
                                                                    </div>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Condiciones para activar el webhook</label>
                                                                    <div class="webhook-conditions"
                                                                        id="webhookConditions">
                                                                        <div class="condition-row">
                                                                            <select
                                                                                class="form-control condition-field">
                                                                                <option value="flow">Flujo</option>
                                                                                <option value="step">Paso</option>
                                                                                <option value="message">Mensaje</option>
                                                                                <option value="user">Usuario</option>
                                                                            </select>
                                                                            <select
                                                                                class="form-control condition-operator">
                                                                                <option value="equals">igual a</option>
                                                                                <option value="not_equals">no igual a
                                                                                </option>
                                                                                <option value="contains">contiene
                                                                                </option>
                                                                                <option value="starts_with">comienza con
                                                                                </option>
                                                                                <option value="ends_with">termina con
                                                                                </option>
                                                                            </select>
                                                                            <input type="text"
                                                                                class="form-control condition-value"
                                                                                placeholder="Valor">
                                                                            <button type="button"
                                                                                class="btn btn-outline-danger"
                                                                                onclick="removeCondition(this)">
                                                                                <i class="fas fa-times"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <button type="button"
                                                                        class="btn btn-sm btn-outline-secondary mt-2"
                                                                        onclick="addWebhookCondition()">
                                                                        <i class="fas fa-plus"></i> A√±adir Condici√≥n
                                                                    </button>
                                                                </div>

                                                                <div class="form-group">
                                                                    <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox"
                                                                            id="webhookActive" checked>
                                                                        <label class="form-check-label"
                                                                            for="webhookActive">Webhook activo</label>
                                                                    </div>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Probar Webhook</label>
                                                                    <div class="webhook-test-container">
                                                                        <button type="button" class="btn btn-info"
                                                                            onclick="testWebhook()">
                                                                            <i class="fas fa-paper-plane"></i> Enviar
                                                                            Prueba
                                                                        </button>
                                                                        <div class="test-result" id="webhookTestResult"
                                                                            style="display: none;">
                                                                            <div class="result-status">
                                                                                <span class="status-icon success"><i
                                                                                        class="fas fa-check-circle"></i></span>
                                                                                <span class="status-text">Webhook
                                                                                    enviado exitosamente</span>
                                                                            </div>
                                                                            <div class="result-details">
                                                                                <p><strong>Status:</strong> <span
                                                                                        id="webhookTestStatus">200
                                                                                        OK</span></p>
                                                                                <p><strong>Tiempo:</strong> <span
                                                                                        id="webhookTestTime">245ms</span>
                                                                                </p>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button class="btn btn-secondary"
                                                                onclick="closeWebhookModal()">
                                                                <i class="fas fa-times"></i> Cancelar
                                                            </button>
                                                            <button class="btn btn-success"
                                                                onclick="saveWebhookConfig()">
                                                                <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Modal para configurar acci√≥n entrante -->
                                                <div class="modal-overlay" id="actionConfigModal"
                                                    style="display: none;">
                                                    <div class="modal-container action-config-modal">
                                                        <div class="modal-header">
                                                            <h5 id="actionModalTitle">Configurar Acci√≥n</h5>
                                                            <button type="button" class="modal-close"
                                                                onclick="closeActionModal()">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form id="actionConfigForm">
                                                                <div class="form-group">
                                                                    <label>Par√°metros requeridos</label>
                                                                    <div id="actionParamsContainer">
                                                                        <div class="param-row">
                                                                            <div class="input-group mb-2">
                                                                                <input type="text"
                                                                                    class="form-control param-name"
                                                                                    placeholder="Nombre del par√°metro"
                                                                                    value="user_id">
                                                                                <select class="form-control param-type">
                                                                                    <option value="string">Texto
                                                                                    </option>
                                                                                    <option value="number">N√∫mero
                                                                                    </option>
                                                                                    <option value="boolean">Booleano
                                                                                    </option>
                                                                                    <option value="object">Objeto
                                                                                    </option>
                                                                                </select>
                                                                                <div
                                                                                    class="form-check form-check-inline ml-2">
                                                                                    <input
                                                                                        class="form-check-input param-required"
                                                                                        type="checkbox" checked>
                                                                                    <label
                                                                                        class="form-check-label">Requerido</label>
                                                                                </div>
                                                                                <div class="input-group-append">
                                                                                    <button
                                                                                        class="btn btn-outline-danger"
                                                                                        type="button"
                                                                                        onclick="removeParamRow(this)">
                                                                                        <i class="fas fa-times"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="param-row">
                                                                            <div class="input-group mb-2">
                                                                                <input type="text"
                                                                                    class="form-control param-name"
                                                                                    placeholder="Nombre del par√°metro"
                                                                                    value="message">
                                                                                <select class="form-control param-type">
                                                                                    <option value="string">Texto
                                                                                    </option>
                                                                                    <option value="number">N√∫mero
                                                                                    </option>
                                                                                    <option value="boolean">Booleano
                                                                                    </option>
                                                                                    <option value="object">Objeto
                                                                                    </option>
                                                                                </select>
                                                                                <div
                                                                                    class="form-check form-check-inline ml-2">
                                                                                    <input
                                                                                        class="form-check-input param-required"
                                                                                        type="checkbox" checked>
                                                                                    <label
                                                                                        class="form-check-label">Requerido</label>
                                                                                </div>
                                                                                <div class="input-group-append">
                                                                                    <button
                                                                                        class="btn btn-outline-danger"
                                                                                        type="button"
                                                                                        onclick="removeParamRow(this)">
                                                                                        <i class="fas fa-times"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <button type="button"
                                                                        class="btn btn-sm btn-outline-secondary"
                                                                        onclick="addActionParam()">
                                                                        <i class="fas fa-plus"></i> A√±adir Par√°metro
                                                                    </button>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Acci√≥n a ejecutar</label>
                                                                    <select class="form-control"
                                                                        id="actionImplementation">
                                                                        <option value="sendMessage">Enviar mensaje al
                                                                            usuario</option>
                                                                        <option value="startFlow">Iniciar un flujo
                                                                            espec√≠fico</option>
                                                                        <option value="changeStep">Cambiar de paso
                                                                        </option>
                                                                        <option value="updateVariable">Actualizar
                                                                            variable de sesi√≥n</option>
                                                                        <option value="custom">Funci√≥n personalizada
                                                                        </option>
                                                                    </select>
                                                                </div>

                                                                <div class="form-group" id="actionCustomCodeContainer"
                                                                    style="display: none;">
                                                                    <label>C√≥digo personalizado</label>
                                                                    <textarea class="form-control" id="actionCustomCode"
                                                                        rows="6" style="font-family: monospace;">async function customAction(client, params, session) {
  // Implementaci√≥n personalizada
  const userId = params.user_id;
  const message = params.message;
  
  // Enviar mensaje al usuario
  await client.sendMessage(userId, message);
  
  return { success: true };
}</textarea>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Ejemplo de JSON para pruebas</label>
                                                                    <textarea class="form-control" id="actionTestJson"
                                                                        rows="4" style="font-family: monospace;">{
  "user_id": "1234567890",
  "message": "Este es un mensaje de prueba"
}</textarea>
                                                                </div>

                                                                <div class="form-group">
                                                                    <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox"
                                                                            id="actionResponseEnabled" checked>
                                                                        <label class="form-check-label"
                                                                            for="actionResponseEnabled">Enviar respuesta
                                                                            al completar la acci√≥n</label>
                                                                    </div>
                                                                    <select class="form-control mt-2"
                                                                        id="actionResponseFormat">
                                                                        <option value="json">JSON</option>
                                                                        <option value="text">Texto plano</option>
                                                                    </select>
                                                                </div>
                                                            </form>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button class="btn btn-secondary"
                                                                onclick="closeActionModal()">
                                                                <i class="fas fa-times"></i> Cancelar
                                                            </button>
                                                            <button class="btn btn-success"
                                                                onclick="saveActionConfig()">
                                                                <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Modal para configurar integraci√≥n -->
                                                <div class="modal-overlay" id="integrationModal" style="display: none;">
                                                    <div class="modal-container integration-modal">
                                                        <div class="modal-header">
                                                            <h5 id="integrationModalTitle">Configurar Integraci√≥n</h5>
                                                            <button type="button" class="modal-close"
                                                                onclick="closeIntegrationModal()">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body" id="integrationModalBody">
                                                            <!-- El contenido se cargar√° din√°micamente seg√∫n la integraci√≥n -->
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button class="btn btn-secondary"
                                                                onclick="closeIntegrationModal()">
                                                                <i class="fas fa-times"></i> Cancelar
                                                            </button>
                                                            <button class="btn btn-success"
                                                                onclick="saveIntegrationConfig()">
                                                                <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="webhooks-save-actions">
                                                    <button class="btn btn-primary" onclick="saveWebhooksSettings()">
                                                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                                    </button>
                                                    <button class="btn btn-outline-secondary"
                                                        onclick="generateWebhooksFlowCode()">
                                                        <i class="fas fa-code"></i> Generar C√≥digo de Integraci√≥n
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Pesta√±a de c√≥digo -->
                                        <div class="tab-pane" id="flowCodeTab">
                                            <div class="flow-code-container">
                                                <div class="flow-code-header">
                                                    <h5>C√≥digo Generado</h5>
                                                    <button class="btn btn-sm btn-outline-secondary"
                                                        onclick="copyFlowCode()">
                                                        <i class="fas fa-copy"></i> Copiar C√≥digo
                                                    </button>
                                                </div>
                                                <div class="flow-code-editor">
                                                    <pre><code class="javascript" id="flowGeneratedCode">// El c√≥digo se generar√° autom√°ticamente</code></pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel derecho: Propiedades -->
                        <!--<div class="flow-properties" id="flowProperties">
                            <div class="properties-header">
                                <h4>Propiedades</h4>
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleProperties()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="properties-content" id="propertiesContent">
                                <div class="empty-state">
                                    <i class="fas fa-sliders-h"></i>
                                    <p>Selecciona un elemento para ver sus propiedades</p>
                                </div>
                            </div>
                        </div>-->
                    </div>

                    <!-- Vista previa del flujo -->
                    <div class="flow-preview" id="flowPreview" style="display: none;">
                        <div class="preview-header">
                            <h4>Vista Previa: <span id="previewFlowName">Nombre del Flujo</span></h4>
                            <button class="btn btn-outline-secondary" onclick="closePreview()">
                                <i class="fas fa-times"></i> Cerrar
                            </button>
                        </div>
                        <div class="preview-container">
                            <div class="phone-mockup">
                                <div class="phone-header">
                                    <div class="phone-contact">
                                        <div class="contact-avatar">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div class="contact-info">
                                            <div class="contact-name" id="previewBotName">Bot de WhatsApp</div>
                                            <div class="contact-status">En l√≠nea</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="phone-chat" id="previewChat">
                                    <!-- Los mensajes de chat se generar√°n aqu√≠ -->
                                </div>
                                <div class="phone-input">
                                    <input type="text" placeholder="Escribe un mensaje" id="previewUserInput">
                                    <button onclick="sendPreviewMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="preview-info">
                                <div class="preview-step">
                                    <h5>Paso Actual</h5>
                                    <div class="preview-step-value" id="previewCurrentStep">INITIAL</div>
                                </div>
                                <div class="preview-variables">
                                    <h5>Variables</h5>
                                    <div class="preview-variables-list" id="previewVariables">
                                        <!-- Variables se mostrar√°n aqu√≠ -->
                                    </div>
                                </div>
                                <div class="preview-actions">
                                    <button class="btn btn-secondary" onclick="resetPreview()">
                                        <i class="fas fa-sync"></i> Reiniciar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Constructor de Men√∫s -->
                <div id="menus" class="section">
                    <div class="card">
                        <h3><i class="fas fa-mobile-alt"></i> Constructor de Men√∫s Interactivos</h3>

                        <div class="tab-buttons">
                            <div class="tab-button active" onclick="switchMenuTab('builder')">Constructor</div>
                            <div class="tab-button" onclick="switchMenuTab('preview')">Vista Previa</div>
                            <div class="tab-button" onclick="switchMenuTab('code')">C√≥digo</div>
                        </div>

                        <div id="menu-builder" class="tab-content active">
                            <div class="grid-2">
                                <div>
                                    <h4>Configuraci√≥n del Men√∫</h4>
                                    <div class="form-group">
                                        <label>Nombre del Men√∫</label>
                                        <input type="text" class="form-control" id="menuBuilderName"
                                            value="MENU_PRINCIPAL">
                                    </div>
                                    <div class="form-group">
                                        <label>Mensaje de Bienvenida</label>
                                        <textarea class="form-control" id="menuBuilderMessage"
                                            rows="3">¬°Hola! Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte hoy?</textarea>
                                    </div>
                                </div>
                                <div>
                                    <h4>Opciones del Men√∫</h4>
                                    <div id="menuBuilderOptions">
                                        <div class="menu-option"
                                            style="border: 1px solid #e9ecef; padding: 10px; margin: 5px 0; border-radius: 8px;">
                                            <div
                                                style="display: flex; justify-content: space-between; align-items: center;">
                                                <span>1Ô∏è‚É£ Ver Servicios</span>
                                                <button class="btn btn-danger" onclick="removeMenuOption(this)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <input type="text" class="form-control" value="Ver Servicios"
                                                placeholder="Texto de la opci√≥n">
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" onclick="addMenuOption()">
                                        <i class="fas fa-plus"></i> Agregar Opci√≥n
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="menu-preview" class="tab-content" style="display: none;">
                            <div
                                style="background: #f8f9fa; padding: 20px; border-radius: 10px; max-width: 400px; margin: 0 auto;">
                                <div
                                    style="background: #25D366; color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                    <div id="menuPreviewMessage">¬°Hola! Soy tu asistente virtual. ¬øEn qu√© puedo
                                        ayudarte
                                        hoy?</div>
                                </div>
                                <div id="menuPreviewOptions">
                                    <div
                                        style="background: white; padding: 10px; margin: 5px 0; border-radius: 8px; border-left: 4px solid #25D366;">
                                        1Ô∏è‚É£ Ver Servicios
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="menu-code" class="tab-content" style="display: none;">
                            <div class="code-preview" id="menuGeneratedCode">
                                // El c√≥digo se generar√° autom√°ticamente
                            </div>
                            <button class="btn btn-primary" onclick="copyMenuCode()">
                                <i class="fas fa-copy"></i> Copiar C√≥digo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Configuraci√≥n de APIs -->
                <div id="apis" class="section">
                    <div class="card">
                        <h3><i class="fas fa-plug"></i> Configuraci√≥n de APIs</h3>

                        <div class="grid-2">
                            <div>
                                <h4>APIs del Sistema</h4>
                                <div class="form-group">
                                    <label>API de Folios</label>
                                    <input type="url" class="form-control" id="apiConfigFolio"
                                        placeholder="https://tuempresa.com/api/folio.php">
                                </div>
                                <div class="form-group">
                                    <label>API de Servicios</label>
                                    <input type="url" class="form-control" id="apiConfigServicios"
                                        placeholder="https://tuempresa.com/api/servicios.php">
                                </div>
                                <div class="form-group">
                                    <label>API de Garant√≠as</label>
                                    <input type="url" class="form-control" id="apiConfigGarantias"
                                        placeholder="https://tuempresa.com/api/garantias.php">
                                </div>
                            </div>

                            <div>
                                <h4>Configuraci√≥n Avanzada</h4>
                                <div class="form-group">
                                    <label>Timeout de API (segundos)</label>
                                    <input type="number" class="form-control" id="apiConfigTimeout" value="30" min="5"
                                        max="120">
                                </div>
                                <div class="form-group">
                                    <label>Reintentos en caso de error</label>
                                    <input type="number" class="form-control" id="apiConfigRetries" value="3" min="1"
                                        max="10">
                                </div>
                                <div class="form-group">
                                    <label>Contrase√±a de API</label>
                                    <input type="password" class="form-control" id="apiConfigPassword"
                                        placeholder="Token de seguridad">
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="testAllApis()">
                                <i class="fas fa-vial"></i> Probar APIs
                            </button>
                            <button class="btn btn-success" onclick="saveApiConfig()">
                                <i class="fas fa-save"></i> Guardar Configuraci√≥n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Configuraci√≥n de IA -->
                <div id="ai-config" class="section">
                    <div class="card">
                        <h3><i class="fas fa-brain"></i> Configuraci√≥n de IA y Gemini</h3>

                        <div class="grid-2">
                            <div>
                                <h4>Configuraci√≥n de Gemini</h4>
                                <div class="form-group">
                                    <label>Google API Key</label>
                                    <input type="password" class="form-control" id="aiConfigGeminiKey"
                                        placeholder="Tu API Key de Google">
                                </div>
                                <div class="form-group">
                                    <label>Modelo a Usar</label>
                                    <select class="form-control" id="aiConfigModel">
                                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Recomendado)</option>
                                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                        <option value="gemini-pro">Gemini Pro</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <h4>Configuraci√≥n del Comportamiento</h4>
                                <div class="form-group">
                                    <label>Nombre del Asistente</label>
                                    <input type="text" class="form-control" id="aiConfigBotName" value="Jbot"
                                        placeholder="Nombre del bot">
                                </div>
                                <div class="form-group">
                                    <label>Tono de Conversaci√≥n</label>
                                    <select class="form-control" id="aiConfigTone">
                                        <option value="amigable">Amigable y Casual</option>
                                        <option value="profesional">Profesional</option>
                                        <option value="formal">Formal</option>
                                        <option value="entusiasta">Entusiasta</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Prompt del Sistema</label>
                            <textarea class="form-control" id="aiConfigSystemPrompt" rows="5"
                                placeholder="Define c√≥mo debe comportarse tu bot...">Eres un asistente virtual especializado en ayudar a los clientes. Mant√©n un tono profesional pero c√°lido, y siempre trata de ser √∫til y eficiente.</textarea>
                        </div>

                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="testAI()">
                                <i class="fas fa-vial"></i> Probar IA
                            </button>
                            <button class="btn btn-success" onclick="saveAIConfig()">
                                <i class="fas fa-save"></i> Guardar Configuraci√≥n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mensajes Personalizados -->
                <div id="messages" class="section">
                    <div class="card">
                        <h3><i class="fas fa-comments"></i> Biblioteca de Mensajes Personalizados</h3>

                        <div class="tab-buttons">
                            <div class="tab-button active" onclick="switchMessageTab('greetings')">Saludos</div>
                            <div class="tab-button" onclick="switchMessageTab('errors')">Errores</div>
                            <div class="tab-button" onclick="switchMessageTab('confirmations')">Confirmaciones</div>
                        </div>

                        <div id="messages-greetings" class="tab-content active">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Saludo Matutino (6:00 - 12:00)</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgMorningGreeting">¬°Buenos d√≠as! üåÖ ¬øC√≥mo puedo ayudarte hoy?</textarea>
                                </div>
                                <div class="form-group">
                                    <label>Saludo Vespertino (12:00 - 18:00)</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgAfternoonGreeting">¬°Buenas tardes! üåû ¬øEn qu√© puedo asistirte?</textarea>
                                </div>
                                <div class="form-group">
                                    <label>Saludo Nocturno (18:00 - 6:00)</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgEveningGreeting">¬°Buenas noches! üåô ¬øC√≥mo puedo ayudarte?</textarea>
                                </div>
                                <div class="form-group">
                                    <label>Mensaje de Usuario Nuevo</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgNewUser">¬°Hola! Veo que es tu primera vez aqu√≠. Te explico brevemente c√≥mo funciono...</textarea>
                                </div>
                            </div>
                        </div>

                        <div id="messages-errors" class="tab-content" style="display: none;">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Opci√≥n No V√°lida</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgInvalidOption">‚ùå Opci√≥n no v√°lida. Por favor, selecciona una opci√≥n del men√∫.</textarea>
                                </div>
                                <div class="form-group">
                                    <label>Error de API</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgApiError">üòî Ups, algo sali√≥ mal. Por favor, intenta de nuevo en unos momentos.</textarea>
                                </div>
                                <div class="form-group">
                                    <label>Fuera de Horario</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgOutsideHours">üïê Estamos fuera de horario de atenci√≥n.</textarea>
                                </div>
                                <div class="form-group">
                                    <label>Usuario Pausado</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgUserPaused">‚è∏Ô∏è El asistente est√° pausado. Escribe 'reactivar' para continuar.</textarea>
                                </div>
                            </div>
                        </div>

                        <div id="messages-confirmations" class="tab-content" style="display: none;">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Datos Guardados</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgDataSaved">‚úÖ Informaci√≥n guardada correctamente.</textarea>
                                </div>
                                <div class="form-group">
                                    <label>Proceso Completado</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgProcessComplete">üéâ ¬°Proceso completado exitosamente!</textarea>
                                </div>
                                <div class="form-group">
                                    <label>Esperando Respuesta</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgWaitingResponse">‚è≥ Procesando tu solicitud, por favor espera...</textarea>
                                </div>
                                <div class="form-group">
                                    <label>Despedida</label>
                                    <textarea class="form-control" rows="3"
                                        id="msgGoodbye">üëã ¬°Gracias por contactarnos! Que tengas un excelente d√≠a.</textarea>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-success" onclick="saveMessages()">
                            <i class="fas fa-save"></i> Guardar Mensajes
                        </button>
                    </div>
                </div>

                <!-- Anal√≠ticas -->
                <div id="analytics" class="section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="analyticsMessages">0</div>
                            <div class="stat-label">Mensajes Totales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="analyticsUsers">0</div>
                            <div class="stat-label">Usuarios √önicos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="analyticsResponse">0%</div>
                            <div class="stat-label">Tasa de Respuesta</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="analyticsAvgTime">0</div>
                            <div class="stat-label">Tiempo Promedio</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> Gr√°ficos de Actividad</h3>
                        <div
                            style="height: 300px; background: #f8f9fa; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                <i class="fas fa-chart-bar"
                                    style="font-size: 48px; color: #6c757d; margin-bottom: 10px;"></i>
                                <p style="color: #6c757d;">Los gr√°ficos de anal√≠ticas aparecer√°n aqu√≠</p>
                                <button class="btn btn-primary" onclick="loadAnalyticsData()">
                                    <i class="fas fa-sync"></i> Cargar Datos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gesti√≥n de Usuarios -->
                <div id="users" class="section">
                    <div class="card">
                        <h3><i class="fas fa-users"></i> Gesti√≥n de Usuarios Activos</h3>
                        <div style="margin-bottom: 20px;">
                            <input type="text" class="form-control" id="userSearch" placeholder="Buscar usuario..."
                                style="width: 300px; display: inline-block; margin-right: 10px;">
                            <button class="btn btn-primary" onclick="searchUsers()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                            <button class="btn btn-secondary" onclick="refreshUsers()">
                                <i class="fas fa-sync"></i> Actualizar
                            </button>
                        </div>

                        <div id="usersList">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h4>No hay usuarios activos</h4>
                                <p>Los usuarios aparecer√°n aqu√≠ cuando interact√∫en con tus bots.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logs del Sistema -->
                <div id="logs" class="section">
                    <div class="card">
                        <h3><i class="fas fa-clipboard-list"></i> Logs del Sistema</h3>
                        <div style="margin-bottom: 20px;">
                            <select class="form-control" id="logLevel"
                                style="width: 150px; display: inline-block; margin-right: 10px;">
                                <option value="">Todos los niveles</option>
                                <option value="ERROR">Error</option>
                                <option value="WARN">Warning</option>
                                <option value="INFO">Info</option>
                                <option value="DEBUG">Debug</option>
                            </select>
                            <select class="form-control" id="logBot"
                                style="width: 200px; display: inline-block; margin-right: 10px;">
                                <option value="">Todos los bots</option>
                            </select>
                            <button class="btn btn-primary" onclick="refreshLogs()">
                                <i class="fas fa-sync"></i> Actualizar
                            </button>
                            <button class="btn btn-warning" onclick="clearLogs()">
                                <i class="fas fa-trash"></i> Limpiar
                            </button>
                        </div>

                        <div style="background: #1e1e1e; color: #00ff00; padding: 20px; border-radius: 10px; height: 400px; overflow-y: auto; font-family: 'Courier New', monospace;"
                            id="logsContainer">
                            <div style="color: #00ff00;">Sistema de logs cargado correctamente...</div>
                        </div>
                    </div>
                </div>

                <!-- Generador de C√≥digo -->
                <div id="code-generator" class="section">
                    <div class="card">
                        <h3><i class="fas fa-code"></i> Generador de C√≥digo</h3>
                        <div style="margin-bottom: 20px;">
                            <select class="form-control" id="codeGeneratorBot"
                                style="width: 300px; display: inline-block; margin-right: 10px;">
                                <option value="">Selecciona un bot</option>
                            </select>
                            <button class="btn btn-success" onclick="generateBotCode()">
                                <i class="fas fa-cogs"></i> Generar C√≥digo
                            </button>
                            <button class="btn btn-secondary" onclick="downloadBotCode()">
                                <i class="fas fa-download"></i> Descargar
                            </button>
                        </div>

                        <div class="tab-buttons">
                            <div class="tab-button active" onclick="switchCodeTab('main')">app.js</div>
                            <div class="tab-button" onclick="switchCodeTab('package')">package.json</div>
                            <div class="tab-button" onclick="switchCodeTab('env')">env</div>
                        </div>

                        <div id="code-main" class="tab-content active">
                            <div class="code-preview" id="mainCodeContent">
                                // Selecciona un bot para generar su c√≥digo
                            </div>
                        </div>

                        <div id="code-package" class="tab-content" style="display: none;">
                            <div class="code-preview" id="packageCodeContent">
                                // package.json se generar√° aqu√≠
                            </div>
                        </div>

                        <div id="code-env" class="tab-content" style="display: none;">
                            <div class="code-preview" id="envCodeContent">
                                // Variables de entorno se generar√°n aqu√≠
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sistema de Despliegue -->
                <div id="deploy" class="section">
                    <div class="card">
                        <h3><i class="fas fa-rocket"></i> Sistema de Despliegue</h3>

                        <div class="grid-2">
                            <div>
                                <h4>Configuraci√≥n de Despliegue</h4>
                                <div class="form-group">
                                    <label>Servidor de Destino</label>
                                    <select class="form-control" id="deployServer">
                                        <option value="local">Servidor Local</option>
                                        <option value="production">Servidor de Producci√≥n</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Modo de Despliegue</label>
                                    <select class="form-control" id="deployMode">
                                        <option value="development">Desarrollo</option>
                                        <option value="production">Producci√≥n</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <h4>Estado del Sistema</h4>
                                <p><strong>Estado:</strong> <span class="status-indicator status-online"><span
                                            class="status-dot"></span>Operativo</span></p>
                                <p><strong>Bots Desplegados:</strong> <span id="deployedBots">0</span></p>
                                <p><strong>√öltima actualizaci√≥n:</strong> <span id="lastDeployUpdate">Nunca</span>
                                </p>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="deployAllBots()">
                                <i class="fas fa-rocket"></i> Desplegar Todos
                            </button>
                            <button class="btn btn-warning" onclick="restartAllBots()">
                                <i class="fas fa-sync"></i> Reiniciar Todos
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sistema de Respaldos -->
                <div id="backup" class="section">
                    <div class="card">
                        <h3><i class="fas fa-save"></i> Sistema de Respaldos</h3>

                        <div class="grid-2">
                            <div>
                                <h4>Crear Respaldo</h4>
                                <div class="form-group">
                                    <label>Nombre del Respaldo</label>
                                    <input type="text" class="form-control" id="backupName"
                                        placeholder="Respaldo_YYYY-MM-DD">
                                </div>
                                <div class="form-group">
                                    <label>Incluir:</label>
                                    <div>
                                        <label><input type="checkbox" checked> Configuraci√≥n de bots</label><br>
                                        <label><input type="checkbox" checked> Flujos conversacionales</label><br>
                                        <label><input type="checkbox"> Logs del sistema</label><br>
                                        <label><input type="checkbox"> Base de datos</label>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="createBackup()">
                                    <i class="fas fa-save"></i> Crear Respaldo
                                </button>
                            </div>

                            <div>
                                <h4>Respaldos Recientes</h4>
                                <div id="backupsList">
                                    <div class="empty-state">
                                        <i class="fas fa-save"></i>
                                        <h4>No hay respaldos</h4>
                                        <p>Crea tu primer respaldo para proteger tu configuraci√≥n.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monitor de Bots y QR Codes -->
                <div id="bot-monitor" class="section">
                    <div class="card">
                        <h3><i class="fas fa-qrcode"></i> Monitor de Bots y C√≥digos QR</h3>

                        <!-- Selector de Bot -->
                        <div style="margin-bottom: 20px;">
                            <select class="form-control" id="selectedBotForMonitor"
                                style="width: 300px; display: inline-block;">
                                <option value="">Selecciona un bot para monitorear</option>
                            </select>
                            <button class="btn btn-primary" onclick="refreshBotMonitor()">
                                <i class="fas fa-sync"></i> Actualizar
                            </button>
                            <button class="btn btn-success" onclick="startSelectedBot()">
                                <i class="fas fa-play"></i> Iniciar Bot
                            </button>
                            <button class="btn btn-warning" onclick="stopSelectedBot()">
                                <i class="fas fa-stop"></i> Detener Bot
                            </button>
                        </div>

                        <!-- Estado del Bot -->
                        <div class="grid-2" style="margin-bottom: 30px;">
                            <div class="card" style="background: #f8f9fa;">
                                <h5><i class="fas fa-info-circle"></i> Estado del Bot</h5>
                                <div id="botStatusInfo">
                                    <p>Selecciona un bot para ver su estado</p>
                                </div>
                            </div>
                            <div class="card" style="background: #f8f9fa;">
                                <h5><i class="fas fa-chart-line"></i> Estad√≠sticas</h5>
                                <div id="botStatsInfo">
                                    <p>Las estad√≠sticas aparecer√°n aqu√≠</p>
                                </div>
                            </div>
                        </div>

                        <!-- C√≥digo QR -->
                        <div class="card" style="background: #ffffff; border: 2px dashed #25D366; margin-bottom: 20px;">
                            <h5><i class="fas fa-qrcode"></i> C√≥digo QR de WhatsApp</h5>
                            <div id="qrCodeContainer" style="text-align: center; padding: 20px;">
                                <div class="empty-state">
                                    <i class="fas fa-qrcode" style="font-size: 64px; color: #ccc;"></i>
                                    <h4>Esperando c√≥digo QR...</h4>
                                    <div id="qrCanvas"></div>
                                    <p>Inicia un bot para ver su c√≥digo QR aqu√≠</p>
                                    <div class="qr-instructions"
                                        style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                                        <h6><i class="fas fa-mobile-alt"></i> C√≥mo escanear:</h6>
                                        <ol style="text-align: left; margin: 10px 0;">
                                            <li>Abre WhatsApp en tu tel√©fono</li>
                                            <li>Ve a Configuraci√≥n > Dispositivos vinculados</li>
                                            <li>Toca "Vincular un dispositivo"</li>
                                            <li>Escanea el c√≥digo QR que aparece aqu√≠</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Logs en Tiempo Real -->
                        <div class="card">
                            <h5><i class="fas fa-terminal"></i> Logs del Bot en Tiempo Real</h5>
                            <div class="log-controls" style="margin-bottom: 15px;">
                                <button class="btn btn-secondary" onclick="clearBotLogs()">
                                    <i class="fas fa-trash"></i> Limpiar Logs
                                </button>
                                <button class="btn btn-primary" onclick="downloadBotLogs()">
                                    <i class="fas fa-download"></i> Descargar
                                </button>
                                <label style="margin-left: 20px;">
                                    <input type="checkbox" id="autoScrollLogs" checked> Auto-scroll
                                </label>
                            </div>
                            <div id="botLogsContainer"
                                style="background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 8px; height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 10px; white-space: pre-wrap;">
                                <div style="color: #00ff00;">[INFO] Monitor de logs iniciado - Esperando actividad
                                    del
                                    bot...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Notificaciones -->
    <div id="notification" class="notification"></div>

    <script>
        // Variables globales
        let currentStep = 1;
        let selectedPlan = 'emprendedor';
        let currentBot = null;
        let ws = null;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupEventListeners();
            connectWebSocket();
            loadDashboard();
        });

        function initializeApp() {
            generateBotToken();
            updateBotSummary();
            showNotification('Sistema cargado correctamente', 'success');
        }

        function setupEventListeners() {
            // Navegaci√≥n
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = item.getAttribute('data-section');
                    showSection(sectionId);
                });
            });

            // Formularios - actualizar resumen en tiempo real
            const inputs = document.querySelectorAll('#create-bot input, #create-bot select, #create-bot textarea');
            inputs.forEach(input => {
                input.addEventListener('input', updateBotSummary);
                input.addEventListener('change', updateBotSummary);
            });
        }

        // ==================== NAVEGACI√ìN ====================
        function showSection(sectionId) {
            // Actualizar navegaci√≥n
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));

            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            document.getElementById(sectionId).classList.add('active');

            // Cargar datos de la secci√≥n
            loadSectionData(sectionId);
        }

        function loadSectionData(sectionId) {
            switch (sectionId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'bots':
                    loadBots();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                default:
                    break;
            }
        }

        // ==================== WIZARD DE CREACI√ìN ====================
        function nextStep(step) {
            if (validateCurrentStep()) {
                currentStep = step;
                showWizardStep(step);
                updateProgress();
                updateBotSummary();
            }
        }

        function prevStep(step) {
            currentStep = step;
            showWizardStep(step);
            updateProgress();
        }

        function showWizardStep(step) {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
        }

        function updateProgress() {
            const progress = (currentStep / 4) * 100;
            document.getElementById('wizardProgress').style.width = `${progress}%`;
        }

        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    const botName = document.getElementById('botName').value.trim();
                    const companyName = document.getElementById('companyName').value.trim();
                    if (!botName || !companyName) {
                        showNotification('Por favor completa todos los campos requeridos', 'error');
                        return false;
                    }
                    return true;
                case 2:
                    const adminNumber = document.getElementById('adminNumber').value.trim();
                    if (!adminNumber || !/^521\d{10}$/.test(adminNumber)) {
                        showNotification('El n√∫mero de administrador debe tener el formato 521XXXXXXXXXX', 'error');
                        return false;
                    }
                    return true;
                default:
                    return true;
            }
        }

        // ==================== GESTI√ìN DE TOKENS ====================
        function generateBotToken() {
            const token = generateRandomToken(32);
            document.getElementById('botToken').value = token;
            document.getElementById('tokenPreview').textContent = token.substring(0, 8) + '...';
            updateBotSummary();
        }

        function generateRandomToken(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        // ==================== CONFIGURACI√ìN DE IA ====================
        function toggleAIConfig() {
            const enableAI = document.getElementById('enableAI').checked;
            const aiConfig = document.getElementById('aiConfig');
            aiConfig.style.display = enableAI ? 'block' : 'none';
        }

        // ==================== SELECCI√ìN DE PLANES ====================
        function selectPlan(planType) {
            selectedPlan = planType;
            document.querySelectorAll('.plan-card').forEach(card => card.classList.remove('selected'));
            document.querySelector(`[data-plan="${planType}"]`).classList.add('selected');

            const selectElement = document.getElementById('selectedPlan');
            if (selectElement) {
                selectElement.value = planType;
            }

            const planNames = {
                emprendedor: 'Emprendedor Local',
                profesional: 'Profesional Eficiente',
                empresarial: 'Empresarial Avanzado'
            };

            showNotification(`Plan ${planNames[planType]} seleccionado`, 'success');
            updateBotSummary();
        }

        // ==================== RESUMEN DEL BOT ====================
        function updateBotSummary() {
            const summary = document.getElementById('botSummary');
            if (!summary) return;

            const botName = document.getElementById('botName').value || 'Sin nombre';
            const companyName = document.getElementById('companyName').value || 'Sin empresa';
            const plan = document.getElementById('selectedPlan').value;
            const token = document.getElementById('botToken').value;
            const enableAI = document.getElementById('enableAI').checked;
            const adminNumber = document.getElementById('adminNumber').value || 'No configurado';

            summary.innerHTML = `
                <div class="grid-2">
                    <div>
                        <p><strong>Nombre del Bot:</strong> ${botName}</p>
                        <p><strong>Empresa:</strong> ${companyName}</p>
                        <p><strong>Plan:</strong> ${plan}</p>
                        <p><strong>N√∫mero Admin:</strong> ${adminNumber}</p>
                    </div>
                    <div>
                        <p><strong>URL del Bot:</strong> <small>localhost/${token.substring(0, 8)}...</small></p>
                        <p><strong>IA Habilitada:</strong> ${enableAI ? '‚úÖ S√≠' : '‚ùå No'}</p>
                        <p><strong>Estado:</strong> <span class="status-indicator status-loading"><span class="status-dot"></span>Pendiente</span></p>
                        <p><strong>Token:</strong> <small>${token.substring(0, 16)}...</small></p>
                    </div>
                </div>
            `;
        }

        // ==================== CREAR BOT ====================
        async function createBot() {
            if (!validateCurrentStep()) return;

            const createBtn = document.getElementById('createBotBtn');
            const originalText = createBtn.innerHTML;

            // Deshabilitar bot√≥n y mostrar loading
            createBtn.disabled = true;
            createBtn.innerHTML = '<div class="loading"></div> Creando...';

            const botConfig = {
                name: document.getElementById('botName').value.trim(),
                company: document.getElementById('companyName').value.trim(),
                plan: document.getElementById('selectedPlan').value,
                token: document.getElementById('botToken').value,
                description: document.getElementById('businessDescription').value.trim(),
                adminNumber: document.getElementById('adminNumber').value.trim(),
                commandPrefix: document.getElementById('commandPrefix').value,
                apiBaseUrl: document.getElementById('apiBaseUrl').value.trim(),
                apiPassword: document.getElementById('apiPassword').value.trim(),
                enableAI: document.getElementById('enableAI').checked,
                geminiApiKey: document.getElementById('geminiApiKey').value.trim(),
                sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
                defaultPause: parseInt(document.getElementById('defaultPause').value)
            };

            try {
                showNotification('Creando bot...', 'info');

                const response = await fetch('/api/bots/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(botConfig)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('¬°Bot creado exitosamente!', 'success');

                    // Mostrar informaci√≥n del bot creado
                    setTimeout(() => {
                        showNotification(`Bot disponible en: localhost/${botConfig.token.substring(0, 8)}...`, 'info');
                    }, 2000);

                    // Resetear formulario y volver al dashboard
                    setTimeout(() => {
                        resetWizard();
                        showSection('dashboard');
                        loadDashboard();
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Error creando el bot');
                }
            } catch (error) {
                console.error('Error creating bot:', error);
                showNotification('Error al crear el bot: ' + error.message, 'error');
            } finally {
                // Restaurar bot√≥n
                createBtn.disabled = false;
                createBtn.innerHTML = originalText;
            }
        }

        function resetWizard() {
            currentStep = 1;
            showWizardStep(1);
            updateProgress();

            // Limpiar formularios
            document.querySelectorAll('#create-bot input, #create-bot textarea, #create-bot select').forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.id !== 'selectedPlan' && input.id !== 'commandPrefix' &&
                    input.id !== 'sessionTimeout' && input.id !== 'defaultPause') {
                    input.value = '';
                }
            });

            // Valores por defecto
            document.getElementById('selectedPlan').value = 'emprendedor';
            document.getElementById('commandPrefix').value = '!';
            document.getElementById('sessionTimeout').value = '15';
            document.getElementById('defaultPause').value = '30';

            generateBotToken();
            toggleAIConfig();
            updateBotSummary();
        }

        // ==================== CARGAR DATOS ====================
        async function loadDashboard() {
            try {
                // Verificar si el usuario es admin
                const isAdmin = auth.isAdmin();

                // A√±adir o quitar clase al body seg√∫n el rol
                if (isAdmin) {
                    document.body.classList.add('is-admin');
                } else {
                    document.body.classList.remove('is-admin');
                }

                const response = await fetch('/api/analytics/dashboard');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalBots').textContent = data.stats.totalBots || 0;
                    document.getElementById('totalMessages').textContent = (data.stats.totalMessages || 0).toLocaleString();

                    // Estos datos solo se mostrar√°n visualmente a administradores debido al CSS
                    // pero a√∫n as√≠ actualizamos el contenido por seguridad
                    if (isAdmin) {
                        document.getElementById('totalClients').textContent = data.stats.activeBots || 0;
                        document.getElementById('monthlyRevenue').textContent = `$${(data.stats.totalRevenue || 0).toLocaleString()}`;
                    } else {
                        // Para no-admins, limpiar estos valores aunque est√©n ocultos
                        document.getElementById('totalClients').textContent = "***";
                        document.getElementById('monthlyRevenue').textContent = "$***";
                    }
                }

                await loadRecentBots();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                // Valores por defecto si hay error
                document.getElementById('totalBots').textContent = '0';
                document.getElementById('totalMessages').textContent = '0';

                if (auth.isAdmin()) {
                    document.getElementById('totalClients').textContent = '0';
                    document.getElementById('monthlyRevenue').textContent = '$0';
                }
            }
        }

        async function loadRecentBots() {
            try {
                const response = await fetch('/api/bots');
                const data = await response.json();

                const container = document.getElementById('recentBots');

                if (data.success && data.bots.length > 0) {
                    container.innerHTML = data.bots.slice(0, 3).map(bot => `
                        <div class="bot-card" onclick="viewBot('${bot.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong>${bot.name}</strong>
                                <span class="status-indicator status-${bot.status === 'running' ? 'online' : 'offline'}">
                                    <span class="status-dot"></span>${bot.status === 'running' ? 'En l√≠nea' : 'Pausado'}
                                </span>
                            </div>
                            <p><strong>Empresa:</strong> ${bot.company}</p>
                            <p><strong>Plan:</strong> ${bot.plan}</p>
                            <p><strong>URL:</strong> <small>localhost/${bot.token.substring(0, 8)}...</small></p>
                            <p><strong>Mensajes:</strong> ${bot.stats?.messages || 0}</p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-robot"></i>
                            <h4>¬°Bienvenido al Bot Manager!</h4>
                            <p>No tienes bots creados a√∫n. ¬°Comienza creando tu primer bot!</p>
                            <button class="btn btn-primary" onclick="showSection('create-bot')">
                                <i class="fas fa-plus"></i> Crear Mi Primer Bot
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading recent bots:', error);
            }
        }

        async function loadBots() {
            try {
                // Primero, forzar una verificaci√≥n de estado de los bots
                await fetch('/api/bots/verify-status', {
                    method: 'POST'
                }).catch(err => console.warn('Error verificando estado de bots:', err));

                // Luego cargar los bots
                const response = await fetch('/api/bots');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('botsList');

                    if (data.bots.length > 0) {
                        const user = auth.getUser();

                        container.innerHTML = data.bots.map(bot => `
                    <div class="bot-card" onclick="selectBot('${bot.id}', event)">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4>${bot.name}</h4>
                            <span class="status-indicator status-${bot.status === 'running' || bot.status === 'authenticated' ? 'online' : 'offline'}">
                                <span class="status-dot"></span>${getStatusText(bot.status)}
                            </span>
                        </div>
                        <div class="grid-2">
                            <div>
                                <p><strong>Empresa:</strong> ${bot.company}</p>
                                <p><strong>Plan:</strong> ${bot.plan}</p>
                                <p><strong>Mensajes:</strong> ${bot.stats?.messages || 0}</p>
                            </div>
                            <div>
                                <p><strong>URL:</strong> <small>localhost/${bot.token.substring(0, 8)}...</small></p>
                                <p><strong>Usuarios:</strong> ${bot.stats?.users || 0}</p>
                                <p><strong>Creado:</strong> ${new Date(bot.createdAt).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-${bot.status === 'running' || bot.status === 'authenticated' ? 'warning' : 'success'}" 
                                    onclick="toggleBot('${bot.id}', event)">
                                <i class="fas fa-${bot.status === 'running' || bot.status === 'authenticated' ? 'pause' : 'play'}"></i> 
                                ${bot.status === 'running' || bot.status === 'authenticated' ? 'Pausar' : 'Iniciar'}
                            </button>
                            <button class="btn btn-secondary" onclick="viewBotUrl('${bot.token}'); event.stopPropagation();">
                                <i class="fas fa-external-link-alt"></i> Ver URL
                            </button>
                            <button class="btn btn-primary" onclick="downloadBot('${bot.id}'); event.stopPropagation();">
                                <i class="fas fa-download"></i> Descargar
                            </button>
                            ${auth.isOwner(bot.userId) ? `
                            <button class="btn btn-danger" onclick="deleteBot('${bot.id}'); event.stopPropagation();">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>` : ''}
                        </div>
                    </div>
                `).join('');
                    } else {
                        container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-robot"></i>
                        <h4>No tienes bots creados</h4>
                        <p>¬°Comienza creando tu primer bot para automatizar tu negocio!</p>
                        <button class="btn btn-primary" onclick="showSection('create-bot')">
                            <i class="fas fa-plus"></i> Crear Mi Primer Bot
                        </button>
                    </div>
                `;
                    }
                } else {
                    showNotification('Error al cargar los bots: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error loading bots:', error);
                showNotification('Error al cargar los bots', 'error');
            }
        }

        // Funci√≥n auxiliar para obtener texto del estado del bot
        function getStatusText(status) {
            switch (status) {
                case 'running': return 'Activo';
                case 'starting': return 'Iniciando';
                case 'stopping': return 'Deteniendo';
                case 'stopped': return 'Pausado';
                case 'authenticated': return 'Autenticado';
                case 'error': return 'Error';
                case 'disconnected': return 'Desconectado';
                default: return status;
            }
        }

        // ==================== GESTI√ìN DE BOTS ====================
        function selectBot(botId, event) {
            currentBot = botId;
            document.querySelectorAll('.bot-card').forEach(card => card.classList.remove('active'));
            event.currentTarget.classList.add('active');
            console.log(`Bot seleccionado: ${botId}`);
        }


        async function toggleBot(botId) {
            try {
                // Mostrar indicador de carga
                const toggleBtn = event.target.closest('button');
                const originalText = toggleBtn.innerHTML;
                toggleBtn.disabled = true;
                toggleBtn.innerHTML = '<div class="loading"></div> Procesando...';

                // Obtener el estado actual del bot directamente del servidor
                const response = await fetch(`/api/bots/${botId}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Bot no encontrado');
                }

                // Determinar acci√≥n basada en el estado actual
                const bot = data.bot;
                const isRunning = ['running', 'authenticated', 'ready', 'starting'].includes(bot.status);
                const action = isRunning ? 'stop' : 'start';

                // Notificar al usuario
                showNotification(`${action === 'start' ? 'Iniciando' : 'Deteniendo'} bot...`, 'info');

                // Ejecutar acci√≥n
                const actionResponse = await fetch(`/api/bots/${botId}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await actionResponse.json();

                if (result.success) {
                    showNotification(
                        `Bot ${action === 'start' ? 'iniciado' : 'detenido'} correctamente`,
                        'success'
                    );

                    // Actualizar interfaz directamente sin recargar
                    const newStatus = action === 'start' ? 'starting' : 'stopped';
                    updateBotStatusInUI(botId, newStatus);

                    // Actualizar el bot√≥n
                    toggleBtn.innerHTML = `<i class="fas fa-${action === 'start' ? 'pause' : 'play'}"></i> ${action === 'start' ? 'Pausar' : 'Iniciar'}`;
                    toggleBtn.classList.remove(action === 'start' ? 'btn-success' : 'btn-warning');
                    toggleBtn.classList.add(action === 'start' ? 'btn-warning' : 'btn-success');

                    // Recargar datos completos despu√©s de un peque√±o delay
                    setTimeout(() => {
                        loadBots();
                        loadDashboard();
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error toggling bot:', error);
                showNotification('Error: ' + error.message, 'error');

                // Restaurar bot√≥n
                if (event && event.target) {
                    const toggleBtn = event.target.closest('button');
                    if (toggleBtn) {
                        toggleBtn.disabled = false;
                        toggleBtn.innerHTML = originalText || 'Error';
                    }
                }

                // Intentar recargar para obtener estado correcto
                setTimeout(() => {
                    loadBots();
                }, 1000);
            } finally {
                // Asegurar que el bot√≥n est√© habilitado
                if (event && event.target) {
                    const toggleBtn = event.target.closest('button');
                    if (toggleBtn) {
                        toggleBtn.disabled = false;
                    }
                }
            }
        }


        // Funci√≥n auxiliar para fetch con timeout
        function fetchWithTimeout(url, options = {}) {
            const { timeout = 8000, ...fetchOptions } = options;

            return Promise.race([
                fetch(url, fetchOptions),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Request timeout')), timeout)
                )
            ]);
        }

        function viewBotUrl(token) {
            const url = `https://localhost/${token}`;
            navigator.clipboard.writeText(url).then(() => {
                showNotification('URL copiada al portapapeles', 'success');
            });
            window.open(url, '_blank');
        }

        async function downloadBot(botId) {
            try {
                const response = await fetch(`/api/bots/${botId}/download`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bot_${botId}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showNotification('Bot descargado correctamente', 'success');
                } else {
                    throw new Error('Error al descargar el bot');
                }
            } catch (error) {
                console.error('Error downloading bot:', error);
                showNotification('Error al descargar el bot', 'error');
            }
        }

        async function deleteBot(botId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este bot? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            try {
                const response = await fetch(`/api/bots/${botId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Bot eliminado correctamente', 'success');
                    loadBots();
                    loadDashboard();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error deleting bot:', error);
                showNotification('Error al eliminar el bot: ' + error.message, 'error');
            }
        }

        // ==================== PLANTILLAS ====================
        function selectTemplate(templateType) {
            showNotification(`Plantilla ${templateType} seleccionada`, 'info');
        }

        function applyTemplate(templateType) {
            showSection('create-bot');

            const templates = {
                servicios: {
                    description: 'Bot especializado para talleres, reparaciones y servicios t√©cnicos. Incluye consulta de folios, garant√≠as y sistema de citas.',
                    plan: 'profesional'
                },
                restaurante: {
                    description: 'Bot para restaurante con men√∫ digital, pedidos a domicilio y sistema de reservas.',
                    plan: 'profesional'
                },
                personalizado: {
                    description: 'Bot personalizado seg√∫n las necesidades espec√≠ficas de tu negocio.',
                    plan: 'emprendedor'
                }
            };

            const template = templates[templateType];
            if (template) {
                document.getElementById('businessDescription').value = template.description;
                document.getElementById('selectedPlan').value = template.plan;
                selectPlan(template.plan);
                showNotification(`Plantilla ${templateType} aplicada`, 'success');
            }
        }

        // ==================== UTILIDADES ====================
        function refreshBots() {
            loadBots();
            showNotification('Lista de bots actualizada', 'success');
        }

        function exportBots() {
            showNotification('Funci√≥n de exportaci√≥n en desarrollo', 'info');
        }

        function viewBot(botId) {
            showSection('bots');
            setTimeout(() => selectBot(botId), 100);
        }

        // ==================== NOTIFICACIONES ====================
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // ==================== WEBSOCKET ====================
        function connectWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(`${protocol}//${window.location.host}`);

                ws.onopen = () => {
                    console.log('WebSocket conectado');
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };

                ws.onclose = () => {
                    console.log('WebSocket desconectado');
                    setTimeout(connectWebSocket, 5000);
                };

                ws.onerror = (error) => {
                    console.error('Error en WebSocket:', error);
                };
            } catch (error) {
                console.error('Error conectando WebSocket:', error);
            }
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'bot_status':
                    updateBotStatusInUI(data.botId, data.status);
                    break;
                case 'stats_update':
                    updateStatsInUI(data.stats);
                    break;
                default:
                    break;
            }
        }

        function updateBotStatusInUI(botId, status) {
            // Actualizar todas las tarjetas de bot que coincidan con este ID
            const botCards = document.querySelectorAll(`[onclick*="${botId}"]`);

            botCards.forEach(card => {
                // Actualizar indicador de estado
                const statusIndicator = card.querySelector('.status-indicator');
                if (statusIndicator) {
                    // Determinar estado visual (online/offline)
                    const isOnline = ['running', 'authenticated', 'ready', 'starting'].includes(status);

                    statusIndicator.className = `status-indicator status-${isOnline ? 'online' : 'offline'}`;

                    // Texto descriptivo del estado
                    let statusText = status;
                    switch (status) {
                        case 'running': statusText = 'Activo'; break;
                        case 'authenticated': statusText = 'Autenticado'; break;
                        case 'ready': statusText = 'Listo'; break;
                        case 'starting': statusText = 'Iniciando...'; break;
                        case 'stopping': statusText = 'Deteniendo...'; break;
                        case 'stopped': statusText = 'Detenido'; break;
                        case 'error': statusText = 'Error'; break;
                        case 'disconnected': statusText = 'Desconectado'; break;
                        default: statusText = status;
                    }

                    statusIndicator.innerHTML = `<span class="status-dot"></span>${statusText}`;
                }

                // Actualizar bot√≥n de toggle
                const toggleBtn = card.querySelector('button[onclick*="toggleBot"]');
                if (toggleBtn) {
                    const isOnline = ['running', 'authenticated', 'ready', 'starting'].includes(status);

                    // Actualizar clase y texto del bot√≥n
                    toggleBtn.classList.remove(isOnline ? 'btn-success' : 'btn-warning');
                    toggleBtn.classList.add(isOnline ? 'btn-warning' : 'btn-success');

                    // Actualizar icono y texto
                    toggleBtn.innerHTML = `<i class="fas fa-${isOnline ? 'pause' : 'play'}"></i> ${isOnline ? 'Pausar' : 'Iniciar'}`;
                }
            });

            // Tambi√©n actualizar en monitor de bots si est√° activo
            const botStatusInfo = document.getElementById('botStatusInfo');
            if (botStatusInfo && selectedBotId === botId) {
                // Extraer HTML actual
                const currentHTML = botStatusInfo.innerHTML;

                // Determinar estado visual (online/offline)
                const isOnline = ['running', 'authenticated', 'ready', 'starting'].includes(status);

                // Actualizar solo la parte del estado
                const updatedHTML = currentHTML.replace(
                    /<p><strong>Estado:<\/strong>.*?<\/p>/,
                    `<p><strong>Estado:</strong> <span class="status-indicator status-${isOnline ? 'online' : 'offline'}">
                <span class="status-dot"></span>${getStatusText(status)}</span></p>`
                );

                // Actualizar DOM
                botStatusInfo.innerHTML = updatedHTML;
            }
        } function updateBotStatusInUI(botId, status) {
            // Actualizar todas las tarjetas de bot que coincidan con este ID
            const botCards = document.querySelectorAll(`[onclick*="${botId}"]`);

            botCards.forEach(card => {
                // Actualizar indicador de estado
                const statusIndicator = card.querySelector('.status-indicator');
                if (statusIndicator) {
                    // Determinar estado visual (online/offline)
                    const isOnline = ['running', 'authenticated', 'ready', 'starting'].includes(status);

                    statusIndicator.className = `status-indicator status-${isOnline ? 'online' : 'offline'}`;

                    // Texto descriptivo del estado
                    let statusText = status;
                    switch (status) {
                        case 'running': statusText = 'Activo'; break;
                        case 'authenticated': statusText = 'Autenticado'; break;
                        case 'ready': statusText = 'Listo'; break;
                        case 'starting': statusText = 'Iniciando...'; break;
                        case 'stopping': statusText = 'Deteniendo...'; break;
                        case 'stopped': statusText = 'Detenido'; break;
                        case 'error': statusText = 'Error'; break;
                        case 'disconnected': statusText = 'Desconectado'; break;
                        default: statusText = status;
                    }

                    statusIndicator.innerHTML = `<span class="status-dot"></span>${statusText}`;
                }

                // Actualizar bot√≥n de toggle
                const toggleBtn = card.querySelector('button[onclick*="toggleBot"]');
                if (toggleBtn) {
                    const isOnline = ['running', 'authenticated', 'ready', 'starting'].includes(status);

                    // Actualizar clase y texto del bot√≥n
                    toggleBtn.classList.remove(isOnline ? 'btn-success' : 'btn-warning');
                    toggleBtn.classList.add(isOnline ? 'btn-warning' : 'btn-success');

                    // Actualizar icono y texto
                    toggleBtn.innerHTML = `<i class="fas fa-${isOnline ? 'pause' : 'play'}"></i> ${isOnline ? 'Pausar' : 'Iniciar'}`;
                }
            });

            // Tambi√©n actualizar en monitor de bots si est√° activo
            const botStatusInfo = document.getElementById('botStatusInfo');
            if (botStatusInfo && selectedBotId === botId) {
                // Extraer HTML actual
                const currentHTML = botStatusInfo.innerHTML;

                // Determinar estado visual (online/offline)
                const isOnline = ['running', 'authenticated', 'ready', 'starting'].includes(status);

                // Actualizar solo la parte del estado
                const updatedHTML = currentHTML.replace(
                    /<p><strong>Estado:<\/strong>.*?<\/p>/,
                    `<p><strong>Estado:</strong> <span class="status-indicator status-${isOnline ? 'online' : 'offline'}">
                <span class="status-dot"></span>${getStatusText(status)}</span></p>`
                );

                // Actualizar DOM
                botStatusInfo.innerHTML = updatedHTML;
            }
        }

        function updateStatsInUI(stats) {
            if (stats.totalBots !== undefined) {
                document.getElementById('totalBots').textContent = stats.totalBots;
            }
            if (stats.totalMessages !== undefined) {
                document.getElementById('totalMessages').textContent = stats.totalMessages.toLocaleString();
            }
        }

        // ==================== FUNCIONES PLACEHOLDER ====================
        function loadAnalytics() {
            console.log('Loading analytics...');
        }
    </script>

    <script src="js/auth.js"></script>
    <script src="js/api-interceptor.js"></script>
    <script src="/js/modals.js"></script>
    <script src="https://unpkg.com/qrcode-js@1.0.0/qrcode.min.js"></script>


    <script src="/js/flows.js"></script>
    <script src="/js/menus.js"></script>
    <script src="/js/apis.js"></script>
    <script src="/js/ai-config.js"></script>
    <script src="/js/messages.js"></script>
    <script src="/js/qr-log.js"></script>
    <script>
        // Crear evento personalizado para notificar cambios de secci√≥n
        function notifySectionChange(sectionId) {
            // Crear evento personalizado
            const event = new CustomEvent('sectionChanged', {
                detail: { section: sectionId }
            });

            // Disparar evento
            document.dispatchEvent(event);

            console.log(`Secci√≥n cambiada a: ${sectionId}`);
        }

        // Mejorar la funci√≥n showSection para notificar cambios
        const originalShowSection = window.showSection || function () { };
        window.showSection = function (sectionId) {
            // Llamar a la versi√≥n original
            originalShowSection(sectionId);

            // Notificar del cambio
            notifySectionChange(sectionId);
        };
    </script>
</body>

</html>